{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monero Admin Â· Sovereign Command Center</title>
    
    <!-- Bootstrap 5.3 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css" />
   
    <link rel="stylesheet" href="{% static '/css/admin.css' %}">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
            /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            overflow-x: hidden;
        }

        :root[data-bs-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #0f0f1e 0%, #1a1a2f 100%);
            --sidebar-bg: rgba(22, 22, 40, 0.95);
            --sidebar-hover: rgba(255, 255, 255, 0.05);
            --sidebar-active: rgba(241, 90, 36, 0.2);
            --card-bg: rgba(26, 26, 42, 0.95);
            --border-color: rgba(255, 255, 255, 0.08);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.5);
            --success-bg: rgba(16, 185, 129, 0.2);
            --warning-bg: rgba(245, 158, 11, 0.2);
            --danger-bg: rgba(239, 68, 68, 0.2);
            --info-bg: rgba(59, 130, 246, 0.2);
            --payout-bg: rgba(139, 92, 246, 0.2);
        }

        :root[data-bs-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e6e9f0 100%);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --sidebar-hover: rgba(0, 0, 0, 0.03);
            --sidebar-active: rgba(241, 90, 36, 0.1);
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-color: rgba(0, 0, 0, 0.08);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.1);
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning-bg: rgba(245, 158, 11, 0.1);
            --danger-bg: rgba(239, 68, 68, 0.1);
            --info-bg: rgba(59, 130, 246, 0.1);
            --payout-bg: rgba(139, 92, 246, 0.1);
        }

        /* ===== TOP NAVBAR ===== */
        .navbar {
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            box-shadow: var(--shadow);
            z-index: 1030;
            position: sticky;
            top: 0;
        }

        .brand-text {
            background: linear-gradient(135deg, #f15a24, #ff8c5a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
        }

        .admin-badge {
            background: rgba(241, 90, 36, 0.15);
            color: #f15a24;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .theme-toggle {
            background: var(--sidebar-hover);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .theme-toggle:hover {
            background: var(--sidebar-active);
            transform: rotate(15deg);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f15a24;
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 20px;
            min-width: 18px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f15a24, #ff8c5a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
        }

        /* ===== SIDEBAR ===== */
        .admin-wrapper {
            display: flex;
            min-height: calc(100vh - 72px);
        }

        .admin-sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: sticky;
            top: 72px;
            height: calc(100vh - 72px);
            overflow-y: auto;
            z-index: 1020;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-item-sidebar {
            margin: 0.25rem 0.5rem;
        }

        .nav-link-sidebar {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .nav-link-sidebar i {
            font-size: 1.25rem;
            min-width: 2rem;
        }

        .nav-link-sidebar:hover {
            background: var(--sidebar-hover);
            transform: translateX(5px);
        }

        .nav-link-sidebar.active {
            background: var(--sidebar-active);
            color: #f15a24;
        }

        .nav-link-sidebar.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: #f15a24;
            border-radius: 0 3px 3px 0;
        }

        .nav-text {
            flex: 1;
            font-weight: 500;
        }

        .nav-badge {
            background: #f15a24;
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 20px;
            margin-left: 0.5rem;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-width: calc(100% - 280px);
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 54px;
            height: 54px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }

        .stat-icon.users { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .stat-icon.deposits { background: linear-gradient(135deg, #f59e0b, #f97316); }
        .stat-icon.invested { background: linear-gradient(135deg, #10b981, #14b8a6); }
        .stat-icon.withdrawals { background: linear-gradient(135deg, #ef4444, #f97316); }
        .stat-icon.payouts { background: linear-gradient(135deg, #8b5cf6, #d946ef); }
        .stat-icon i { color: white; }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            line-height: 1.2;
        }

        .stat-value small {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .stat-trend {
            font-size: 0.8rem;
            color: #10b981;
            margin-top: 0.25rem;
        }

        .stat-trend i {
            margin-right: 0.25rem;
        }

        .stat-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }

        .stat-footer-item {
            flex: 1;
            text-align: center;
        }

        .stat-footer-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .stat-footer-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ===== CHARTS ===== */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-header h5 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            font-size: 1.1rem;
        }

        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--sidebar-hover);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .stats-item:hover {
            transform: translateX(5px);
            background: var(--sidebar-active);
        }

        /* ===== TABLES ===== */
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }

        .table-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: var(--shadow);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h4 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-select {
            background: var(--sidebar-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.5rem 2rem 0.5rem 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            min-width: 140px;
        }

        .date-range-picker {
            background: var(--sidebar-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            min-width: 250px;
            cursor: pointer;
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-box input {
            background: var(--sidebar-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            color: var(--text-primary);
            min-width: 250px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #f15a24;
        }

        .btn-action {
            padding: 0.5rem 1.25rem;
            border-radius: 10px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--sidebar-hover);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-action:hover {
            background: #f15a24;
            color: white;
            transform: translateY(-2px);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--sidebar-hover);
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-icon:hover {
            background: #f15a24;
            color: white;
            transform: rotate(15deg);
        }

        .btn-icon.success:hover { background: #10b981; }
        .btn-icon.danger:hover { background: #ef4444; }
        .btn-icon.warning:hover { background: #f59e0b; }
        .btn-icon.info:hover { background: #3b82f6; }
        .btn-icon.payout:hover { background: #8b5cf6; }

        /* Table Styles */
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .modern-table thead th {
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        .modern-table tbody tr {
            background: var(--sidebar-hover);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .modern-table tbody tr:hover {
            transform: scale(1.005);
            box-shadow: var(--shadow);
            background: var(--card-bg);
        }

        .modern-table td {
            padding: 1rem;
            color: var(--text-primary);
            border: none;
        }

        .modern-table td:first-child {
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .modern-table td:last-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.35rem 1rem;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-badge.pending {
            background: var(--warning-bg);
            color: #f59e0b;
        }

        .status-badge.verified,
        .status-badge.completed,
        .status-badge.success {
            background: var(--success-bg);
            color: #10b981;
        }

        .status-badge.rejected,
        .status-badge.danger {
            background: var(--danger-bg);
            color: #ef4444;
        }

        .status-badge.processing,
        .status-badge.info {
            background: var(--info-bg);
            color: #3b82f6;
        }

        .status-badge.payout {
            background: var(--payout-bg);
            color: #8b5cf6;
        }

        /* User Cell */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f15a24, #ff8c5a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
        }

        /* Amount Styling */
        .amount {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
        }

        .amount-positive {
            color: #10b981;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
        }

        .amount-negative {
            color: #ef4444;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
        }

        .amount-payout {
            color: #8b5cf6;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
        }

        /* Action Buttons Group */
        .action-buttons {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        /* KYC Grid */
        .kyc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }

        .kyc-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .kyc-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .kyc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kyc-documents {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .kyc-doc-preview {
            width: 100%;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .kyc-doc-preview:hover {
            transform: scale(1.05);
            border-color: #f15a24;
        }

        /* Pagination */
        .pagination-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination {
            gap: 0.25rem;
        }

        .page-link {
            background: var(--sidebar-hover);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background: #f15a24;
            color: white;
            border-color: #f15a24;
        }

        .page-item.active .page-link {
            background: #f15a24;
            border-color: #f15a24;
        }

        /* Modal Styles */
        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }

        .modal-header .modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--sidebar-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #f15a24;
            box-shadow: 0 0 0 3px rgba(241, 90, 36, 0.1);
        }

        /* Payout Summary Card */
        .payout-summary {
            background: linear-gradient(135deg, #8b5cf6, #d946ef);
            border-radius: 20px;
            padding: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .payout-summary h5 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .payout-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .payout-stat {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .payout-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
        }

        .payout-stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Progress Bar */
        .progress {
            background: var(--sidebar-hover);
            border-radius: 30px;
            height: 6px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #f15a24, #ff8c5a);
            border-radius: 30px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }

        .toast {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            min-width: 350px;
            box-shadow: var(--shadow);
        }

        .toast-body {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast-body i {
            font-size: 1.25rem;
        }

        .toast-success { border-left: 4px solid #10b981; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-warning { border-left: 4px solid #f59e0b; }
        .toast-info { border-left: 4px solid #3b82f6; }

        /* Loading Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: #f15a24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .spinner-text {
            color: var(--text-primary);
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: var(--text-primary);
            color: var(--bg-gradient);
            font-size: 0.8rem;
            border-radius: 8px;
            white-space: nowrap;
            display: none;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        [data-tooltip]:hover:before {
            display: block;
        }

        /* Export Dropdown */
        .export-dropdown {
            background: var(--sidebar-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.5rem;
            min-width: 200px;
        }

        .export-dropdown a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .export-dropdown a:hover {
            background: var(--sidebar-active);
            color: #f15a24;
        }

        /* System Health */
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .health-item {
            background: var(--sidebar-hover);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .health-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .health-status.healthy { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .health-status.warning { background: #f59e0b; box-shadow: 0 0 10px #f59e0b; }
        .health-status.critical { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        /* Responsive */
        @media (max-width: 1200px) {
            .admin-sidebar {
                width: 80px;
                overflow: visible;
            }
            
            .admin-sidebar:hover {
                width: 280px;
                position: absolute;
                z-index: 1050;
                box-shadow: var(--shadow);
            }
            
            .nav-text {
                opacity: 0;
                transition: opacity 0.2s;
            }
            
            .admin-sidebar:hover .nav-text {
                opacity: 1;
            }
            
            .main-content {
                max-width: calc(100% - 80px);
            }
        }

        @media (max-width: 768px) {
            .admin-wrapper {
                flex-direction: column;
            }
            
            .admin-sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                top: auto;
                z-index: 1050;
                border-right: none;
                border-top: 1px solid var(--border-color);
            }
            
            .sidebar-nav {
                display: flex;
                padding: 0.5rem;
                overflow-x: auto;
            }
            
            .nav-item-sidebar {
                flex-shrink: 0;
            }
            
            .nav-link-sidebar {
                padding: 0.75rem;
            }
            
            .nav-link-sidebar i {
                margin: 0;
            }
            
            .main-content {
                max-width: 100%;
                padding: 1rem;
                margin-bottom: 70px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .modern-table {
                min-width: 800px;
            }
            
            .payout-summary-stats {
                grid-template-columns: 1fr;
            }
            
            .kyc-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

</head>
<body>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="loadingSpinner">
    <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text" id="loadingText">Processing...</div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- ========== TOP NAVBAR ========== -->
<nav class="navbar">
    <div class="container-fluid px-0">
        <div class="d-flex align-items-center">
            <a href="{% url 'XMR:index' %}" class="text-decoration-none">
                <span class="fw-bold brand-text">monero</span>
                <span class="admin-badge ms-2">admin</span>
            </a>
        </div>
        
        <div class="d-flex align-items-center gap-3">
            <!-- System Health Indicator -->
            <div class="dropdown">
                <button class="btn btn-icon position-relative" type="button" data-bs-toggle="dropdown" data-tooltip="System Health">
                    <i class="bi bi-heart-pulse fs-5"></i>
                    <span class="health-indicator" style="position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; border-radius: 50%; background: #10b981;"></span>
                </button>
                <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 300px;" id="healthDropdown">
                    <h6>System Health</h6>
                    <div id="healthContent">Loading...</div>
                </div>
            </div>
            
            <!-- Theme Toggle -->
            <button class="theme-toggle" id="themeToggle" data-tooltip="Toggle Theme">
                <i class="bi bi-sun-fill light-icon"></i>
                <i class="bi bi-moon-fill dark-icon"></i>
            </button>
            
            <!-- Notifications -->
            <div class="dropdown">
                <button class="btn btn-icon position-relative" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-bell fs-5"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end" style="min-width: 320px;">
                    <h6 class="dropdown-header d-flex justify-content-between align-items-center">
                        <span>Pending Actions</span>
                        <button class="btn btn-sm btn-link" onclick="refreshNotifications()">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </h6>
                    <a class="dropdown-item d-flex justify-content-between align-items-center" href="#" onclick="switchTab('deposits'); return false;">
                        <span><i class="bi bi-wallet2 me-2 text-warning"></i>Deposits</span>
                        <span class="badge bg-warning rounded-pill" id="pendingDepositsCount">{{ dashboard_stats.pending_deposits|default:"0" }}</span>
                    </a>
                    <a class="dropdown-item d-flex justify-content-between align-items-center" href="#" onclick="switchTab('withdrawals'); return false;">
                        <span><i class="bi bi-cash me-2 text-info"></i>Withdrawals</span>
                        <span class="badge bg-info rounded-pill" id="pendingWithdrawalsCount">{{ dashboard_stats.pending_withdrawals|default:"0" }}</span>
                    </a>
                    <a class="dropdown-item d-flex justify-content-between align-items-center" href="#" onclick="switchTab('kyc'); return false;">
                        <span><i class="bi bi-shield-check me-2 text-primary"></i>KYC Requests</span>
                        <span class="badge bg-primary rounded-pill" id="pendingKycCount">{{ dashboard_stats.pending_kyc|default:"0" }}</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <div class="px-3 py-2">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">New Users Today</span>
                            <span class="fw-bold">{{ dashboard_stats.new_users_today|default:"0" }}</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-1">
                            <span class="text-muted">Active Investments</span>
                            <span class="fw-bold">{{ dashboard_stats.active_investments|default:"0" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Menu -->
            <div class="dropdown">
                <button class="btn p-0" data-bs-toggle="dropdown">
                    <div class="user-avatar">
                        {{ request.user.first_name|first|default:request.user.username|first|upper }}
                    </div>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'XMR:index' %}"><i class="bi bi-house me-2"></i>Home</a></li>
                    <li><a class="dropdown-item" href="{% url 'XMR:account' %}"><i class="bi bi-speedometer2 me-2"></i>User Dashboard</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="openSystemStatus()"><i class="bi bi-heart-pulse me-2"></i>System Status</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportData('users')"><i class="bi bi-download me-2"></i>Export Users</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportData('transactions')"><i class="bi bi-download me-2"></i>Export Transactions</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'XMR:logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- ========== MAIN WRAPPER ========== -->
<div class="admin-wrapper">
    <!-- ========== SIDEBAR ========== -->
    <aside class="admin-sidebar">
        <nav class="sidebar-nav">
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'dashboard' %}active{% endif %}" onclick="switchTab('dashboard'); return false;">
                    <i class="bi bi-speedometer2"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'deposits' %}active{% endif %}" onclick="switchTab('deposits'); return false;">
                    <i class="bi bi-wallet2"></i>
                    <span class="nav-text">Deposits</span>
                    <span class="nav-badge" id="sidebarDepositsCount">{{ dashboard_stats.pending_deposits|default:"0" }}</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'withdrawals' %}active{% endif %}" onclick="switchTab('withdrawals'); return false;">
                    <i class="bi bi-cash"></i>
                    <span class="nav-text">Withdrawals</span>
                    <span class="nav-badge" id="sidebarWithdrawalsCount">{{ dashboard_stats.pending_withdrawals|default:"0" }}</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'investments' %}active{% endif %}" onclick="switchTab('investments'); return false;">
                    <i class="bi bi-graph-up"></i>
                    <span class="nav-text">Investments</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'payouts' %}active{% endif %}" onclick="switchTab('payouts'); return false;">
                    <i class="bi bi-cash-stack"></i>
                    <span class="nav-text">Payouts</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'users' %}active{% endif %}" onclick="switchTab('users'); return false;">
                    <i class="bi bi-people"></i>
                    <span class="nav-text">Users</span>
                    <span class="nav-badge">{{ dashboard_stats.total_users|default:"0" }}</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'tokens' %}active{% endif %}" onclick="switchTab('tokens'); return false;">
                    <i class="bi bi-coin"></i>
                    <span class="nav-text">Tokens</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'kyc' %}active{% endif %}" onclick="switchTab('kyc'); return false;">
                    <i class="bi bi-shield-check"></i>
                    <span class="nav-text">KYC</span>
                    <span class="nav-badge" id="sidebarKycCount">{{ dashboard_stats.pending_kyc|default:"0" }}</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'transactions' %}active{% endif %}" onclick="switchTab('transactions'); return false;">
                    <i class="bi bi-arrow-left-right"></i>
                    <span class="nav-text">Transactions</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'logs' %}active{% endif %}" onclick="switchTab('logs'); return false;">
                    <i class="bi bi-journal-text"></i>
                    <span class="nav-text">System Logs</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar {% if active_tab == 'settings' %}active{% endif %}" onclick="switchTab('settings'); return false;">
                    <i class="bi bi-gear"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </div>
            <div class="nav-item-sidebar">
                <a class="nav-link-sidebar" onclick="openMaintenanceMenu()">
                    <i class="bi bi-wrench"></i>
                    <span class="nav-text">Maintenance</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-pane {% if active_tab == 'dashboard' %}active{% endif %}">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon users">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="bi bi-arrow-up"></i> +{{ dashboard_stats.new_users_today|default:"0" }} today
                        </div>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total Users</span>
                        <div class="stat-value">{{ dashboard_stats.total_users|default:"0" }}</div>
                    </div>
                    <div class="stat-footer">
                        <div class="stat-footer-item">
                            <div class="stat-footer-label">Verified</div>
                            <div class="stat-footer-value">{{ dashboard_stats.verified_users|default:"0" }}</div>
                        </div>
                        <div class="stat-footer-item">
                            <div class="stat-footer-label">New (Week)</div>
                            <div class="stat-footer-value">{{ dashboard_stats.new_users_week|default:"0" }}</div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon deposits">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <div class="stat-trend text-warning">
                            <i class="bi bi-clock"></i> {{ dashboard_stats.pending_deposits|default:"0" }} pending
                        </div>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total Deposits</span>
                        <div class="stat-value">{{ dashboard_stats.total_deposits|floatformat:0|default:"0" }} <small>KSH</small></div>
                    </div>
                    <div class="stat-footer">
                        <div class="stat-footer-item">
                            <div class="stat-footer-label">Today</div>
                            <div class="stat-footer-value">{{ daily_deposits.0.total|floatformat:0|default:"0" }} KSH</div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon invested">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                        <div class="stat-trend text-success">
                            <i class="bi bi-check-circle"></i> {{ dashboard_stats.active_investments|default:"0" }} active
                        </div>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total Invested</span>
                        <div class="stat-value">{{ dashboard_stats.total_invested|floatformat:0|default:"0" }} <small>KSH</small></div>
                    </div>
                    <div class="stat-footer">
                        <div class="stat-footer-item">
                            <div class="stat-footer-label">Locked</div>
                            <div class="stat-footer-value">{{ dashboard_stats.total_locked_balance|floatformat:0|default:"0" }} KSH</div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon withdrawals">
                            <i class="bi bi-arrow-up-right-circle"></i>
                        </div>
                        <div class="stat-trend text-info">
                            <i class="bi bi-clock"></i> {{ dashboard_stats.pending_withdrawals|default:"0" }} pending
                        </div>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total Withdrawals</span>
                        <div class="stat-value">{{ dashboard_stats.total_withdrawals|floatformat:0|default:"0" }} <small>KSH</small></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon payouts">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <div class="stat-trend text-payout">
                            <i class="bi bi-graph-up"></i> {{ dashboard_stats.completed_investments|default:"0" }} completed
                        </div>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total Payouts</span>
                        <div class="stat-value">{{ dashboard_stats.total_profits_paid|floatformat:0|default:"0" }} <small>KSH</small></div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5><i class="bi bi-graph-up me-2"></i>Daily Deposits (7 days)</h5>
                        <button class="btn-icon" onclick="refreshChart()" data-tooltip="Refresh Chart">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="depositsChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h5><i class="bi bi-pie-chart me-2"></i>System Overview</h5>
                    </div>
                    <div class="stats-list">
                        <div class="stats-item">
                            <span>Available Balance</span>
                            <span class="fw-bold">{{ dashboard_stats.total_system_balance|floatformat:0|default:"0" }} KSH</span>
                        </div>
                        <div class="stats-item">
                            <span>Locked Balance</span>
                            <span class="fw-bold">{{ dashboard_stats.total_locked_balance|floatformat:0|default:"0" }} KSH</span>
                        </div>
                        <div class="stats-item">
                            <span>Total Assets</span>
                            <span class="fw-bold">{{ dashboard_stats.total_system_assets|floatformat:0|default:"0" }} KSH</span>
                        </div>
                        <div class="stats-item">
                            <span>Active Investments</span>
                            <span class="fw-bold text-success">{{ dashboard_stats.active_investments|default:"0" }}</span>
                        </div>
                        <div class="stats-item">
                            <span>Completed Investments</span>
                            <span class="fw-bold text-info">{{ dashboard_stats.completed_investments|default:"0" }}</span>
                        </div>
                        <div class="stats-item">
                            <span>Pending KYC</span>
                            <span class="fw-bold text-primary">{{ dashboard_stats.pending_kyc|default:"0" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payout Summary Card -->
            <div class="payout-summary">
                <h5><i class="bi bi-cash-stack me-2"></i>Payout System</h5>
                <div class="payout-summary-stats">
                    <div class="payout-stat">
                        <div class="payout-stat-value" id="dueTodayCount">0</div>
                        <div class="payout-stat-label">Due Today</div>
                    </div>
                    <div class="payout-stat">
                        <div class="payout-stat-value" id="missedCount">0</div>
                        <div class="payout-stat-label">Missed</div>
                    </div>
                    <div class="payout-stat">
                        <div class="payout-stat-value" id="processedToday">0</div>
                        <div class="payout-stat-label">Processed (24h)</div>
                    </div>
                    <div class="payout-stat">
                        <button class="btn btn-light btn-sm" onclick="catchUpAllPayouts()">
                            <i class="bi bi-lightning-charge-fill me-2"></i>Run Catch-Up
                        </button>
                    </div>
                    <div class="payout-stat">
                        <button class="btn btn-light btn-sm" onclick="checkAllPayouts()">
                            <i class="bi bi-search me-2"></i>Check
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row">
                <div class="col-md-6">
                    <div class="table-container">
                        <h5 class="mb-3">Recent Deposits</h5>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if deposits_data %}
                                        {% for deposit in deposits_data|slice:":5" %}
                                        <tr onclick="viewDepositDetails({{ deposit.id }})">
                                            <td>
                                                <div class="user-cell">
                                                    <div class="user-avatar-sm">{{ deposit.user|first|upper }}</div>
                                                    <span>{{ deposit.user }}</span>
                                                </div>
                                            </td>
                                            <td class="amount">{{ deposit.amount|floatformat:2 }} KSH</td>
                                            <td>
                                                <span class="status-badge {% if deposit.status == 'PENDING' %}pending{% elif deposit.status == 'VERIFIED' %}verified{% endif %}">
                                                    {{ deposit.status }}
                                                </span>
                                            </td>
                                            <td><small>{{ deposit.created_at }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="4" class="text-center">No recent deposits</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="table-container">
                        <h5 class="mb-3">Recent Withdrawals</h5>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if withdrawals_data %}
                                        {% for withdrawal in withdrawals_data|slice:":5" %}
                                        <tr onclick="viewWithdrawalDetails({{ withdrawal.id }})">
                                            <td>
                                                <div class="user-cell">
                                                    <div class="user-avatar-sm">{{ withdrawal.user|first|upper }}</div>
                                                    <span>{{ withdrawal.user }}</span>
                                                </div>
                                            </td>
                                            <td class="amount">{{ withdrawal.amount|floatformat:2 }} KSH</td>
                                            <td>
                                                <span class="status-badge {% if withdrawal.status == 'PENDING' %}pending{% elif withdrawal.status == 'PROCESSING' %}processing{% elif withdrawal.status == 'COMPLETED' %}verified{% endif %}">
                                                    {{ withdrawal.status }}
                                                </span>
                                            </td>
                                            <td><small>{{ withdrawal.created_at }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="4" class="text-center">No recent withdrawals</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deposits Tab -->
        <div id="deposits" class="tab-pane {% if active_tab == 'deposits' %}active{% endif %}">
            <div class="table-header">
                <h4>Deposit Management</h4>
                <div class="filter-group">
                    <input type="text" class="date-range-picker" id="depositDateRange" placeholder="Filter by date">
                    <select class="filter-select" id="depositStatusFilter">
                        <option value="PENDING">Pending</option>
                        <option value="VERIFIED">Verified</option>
                        <option value="REJECTED">Rejected</option>
                        <option value="PROCESSING">Processing</option>
                        <option value="">All</option>
                    </select>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="depositSearch" placeholder="Search deposits...">
                    </div>
                    <button class="btn-action" onclick="filterDeposits()">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button class="btn-action" onclick="exportData('deposits')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="depositsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Phone</th>
                                <th>M-Pesa Code</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="depositsTableBody">
                            {% if deposits_data %}
                                {% for deposit in deposits_data %}
                                <tr id="deposit-{{ deposit.id }}">
                                    <td>#{{ deposit.id }}</td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ deposit.user|first|upper }}</div>
                                            <div>
                                                <strong>{{ deposit.user }}</strong>
                                                <small class="d-block text-muted">ID: {{ deposit.user_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="amount">{{ deposit.amount|floatformat:2 }} KSH</td>
                                    <td>{{ deposit.phone }}</td>
                                    <td><code>{{ deposit.mpesa_code|default:"â" }}</code></td>
                                    <td><small>{{ deposit.created_at }}</small></td>
                                    <td>
                                        <span class="status-badge 
                                            {% if deposit.status == 'PENDING' %}pending
                                            {% elif deposit.status == 'VERIFIED' %}verified
                                            {% elif deposit.status == 'REJECTED' %}rejected
                                            {% elif deposit.status == 'PROCESSING' %}processing
                                            {% endif %}">
                                            {{ deposit.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            {% if deposit.status == 'PENDING' %}
                                            <button class="btn-icon success" onclick="verifyDeposit({{ deposit.id }})" data-tooltip="Verify Deposit">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn-icon danger" onclick="rejectDeposit({{ deposit.id }})" data-tooltip="Reject Deposit">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                            {% endif %}
                                            {% if deposit.has_screenshot %}
                                            <button class="btn-icon info" onclick="viewScreenshot('{{ deposit.mpesa_screenshot_url|default:"" }}')" data-tooltip="View Screenshot">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn-icon" onclick="viewDepositDetails({{ deposit.id }})" data-tooltip="View Details">
                                                <i class="bi bi-info-circle"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No deposits found</h5>
                                        <p class="text-muted">Deposits will appear here once users make them.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdrawals Tab -->
        <div id="withdrawals" class="tab-pane {% if active_tab == 'withdrawals' %}active{% endif %}">
            <div class="table-header">
                <h4>Withdrawal Management</h4>
                <div class="filter-group">
                    <input type="text" class="date-range-picker" id="withdrawalDateRange" placeholder="Filter by date">
                    <select class="filter-select" id="withdrawalStatusFilter">
                        <option value="PENDING">Pending</option>
                        <option value="PROCESSING">Processing</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="REJECTED">Rejected</option>
                        <option value="">All</option>
                    </select>
                    <select class="filter-select" id="withdrawalMethodFilter">
                        <option value="">All Methods</option>
                        <option value="MPESA">M-Pesa</option>
                        <option value="BANK">Bank</option>
                    </select>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="withdrawalSearch" placeholder="Search withdrawals...">
                    </div>
                    <button class="btn-action" onclick="filterWithdrawals()">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button class="btn-action" onclick="exportData('withdrawals')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="withdrawalsTable">
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Net</th>
                                <th>Tax</th>
                                <th>Method</th>
                                <th>Details</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTableBody">
                            {% if withdrawals_data %}
                                {% for withdrawal in withdrawals_data %}
                                <tr id="withdrawal-{{ withdrawal.id }}">
                                    <td><code>{{ withdrawal.request_id|truncatechars:10 }}</code></td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ withdrawal.user|first|upper }}</div>
                                            <div>
                                                <strong>{{ withdrawal.user }}</strong>
                                                <small class="d-block text-muted">ID: {{ withdrawal.user_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="amount">{{ withdrawal.amount|floatformat:2 }} KSH</td>
                                    <td class="amount-positive">{{ withdrawal.net_amount|floatformat:2 }} KSH</td>
                                    <td class="amount-negative">{{ withdrawal.tax|floatformat:2 }} KSH</td>
                                    <td>
                                        <span class="badge {% if withdrawal.method == 'MPESA' %}bg-info{% else %}bg-secondary{% endif %}">
                                            {{ withdrawal.method }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if withdrawal.method == 'MPESA' %}
                                            <small>{{ withdrawal.phone }}</small>
                                        {% else %}
                                            <small>Bank Transfer</small>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ withdrawal.created_at }}</small></td>
                                    <td>
                                        <span class="status-badge 
                                            {% if withdrawal.status == 'PENDING' %}pending
                                            {% elif withdrawal.status == 'PROCESSING' %}processing
                                            {% elif withdrawal.status == 'COMPLETED' %}verified
                                            {% elif withdrawal.status == 'REJECTED' %}rejected
                                            {% endif %}">
                                            {{ withdrawal.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            {% if withdrawal.status == 'PENDING' %}
                                            <button class="btn-icon info" onclick="processWithdrawal({{ withdrawal.id }})" data-tooltip="Mark as Processing">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                            <button class="btn-icon success" onclick="completeWithdrawal({{ withdrawal.id }})" data-tooltip="Complete">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn-icon danger" onclick="rejectWithdrawal({{ withdrawal.id }})" data-tooltip="Reject">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                            {% elif withdrawal.status == 'PROCESSING' %}
                                            <button class="btn-icon success" onclick="completeWithdrawal({{ withdrawal.id }})" data-tooltip="Complete">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn-icon danger" onclick="rejectWithdrawal({{ withdrawal.id }})" data-tooltip="Reject">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn-icon" onclick="viewWithdrawalDetails({{ withdrawal.id }})" data-tooltip="View Details">
                                                <i class="bi bi-info-circle"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="10" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No withdrawals found</h5>
                                        <p class="text-muted">Withdrawal requests will appear here.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Investments Tab -->
        <div id="investments" class="tab-pane {% if active_tab == 'investments' %}active{% endif %}">
            <div class="table-header">
                <h4>Investment Management</h4>
                <div class="filter-group">
                    <input type="text" class="date-range-picker" id="investmentDateRange" placeholder="Filter by date">
                    <select class="filter-select" id="investmentStatusFilter">
                        <option value="ACTIVE">Active</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="CANCELLED">Cancelled</option>
                        <option value="">All</option>
                    </select>
                    <select class="filter-select" id="investmentTokenFilter">
                        <option value="">All Tokens</option>
                        {% if tokens_data %}
                            {% for token in tokens_data %}
                            <option value="{{ token.id }}">{{ token.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="investmentSearch" placeholder="Search investments...">
                    </div>
                    <button class="btn-action" onclick="filterInvestments()">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button class="btn-action" onclick="exportData('investments')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="investmentsTable">
                        <thead>
                            <tr>
                                <th>Investment ID</th>
                                <th>User</th>
                                <th>Token</th>
                                <th>Amount</th>
                                <th>Daily Return</th>
                                <th>Progress</th>
                                <th>Total Paid</th>
                                <th>Remaining</th>
                                <th>Start Date</th>
                                <th>Last Payout</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="investmentsTableBody">
                            {% if investments_data %}
                                {% for investment in investments_data %}
                                <tr id="investment-{{ investment.id }}">
                                    <td><code>{{ investment.investment_id|truncatechars:10 }}</code></td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ investment.user|first|upper }}</div>
                                            <div>
                                                <strong>{{ investment.user }}</strong>
                                                <small class="d-block text-muted">ID: {{ investment.user_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ investment.token_name }}</strong>
                                        <small class="d-block text-muted">#{{ investment.token_id }}</small>
                                    </td>
                                    <td class="amount">{{ investment.amount|floatformat:2 }} KSH</td>
                                    <td class="amount-positive">{{ investment.daily_return|floatformat:2 }} KSH</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress flex-grow-1" style="width: 100px;">
                                                <div class="progress-bar" style="width: {{ investment.progress_percentage }}%"></div>
                                            </div>
                                            <small>{{ investment.progress_percentage|floatformat:0 }}%</small>
                                        </div>
                                    </td>
                                    <td class="amount-positive">{{ investment.total_paid|floatformat:2 }} KSH</td>
                                    <td class="amount-payout">{{ investment.remaining_payouts }} days</td>
                                    <td><small>{{ investment.start_date }}</small></td>
                                    <td>
                                        {% if investment.last_payout_date %}
                                            <small>{{ investment.last_payout_date }}</small>
                                        {% else %}
                                            <span class="badge bg-warning">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="status-badge 
                                            {% if investment.status == 'ACTIVE' %}verified
                                            {% elif investment.status == 'COMPLETED' %}success
                                            {% elif investment.status == 'CANCELLED' %}rejected
                                            {% endif %}">
                                            {{ investment.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon info" onclick="viewInvestmentDetails({{ investment.id }})" data-tooltip="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if investment.status == 'ACTIVE' %}
                                            <button class="btn-icon payout" onclick="processPayout({{ investment.id }})" data-tooltip="Process Payout">
                                                <i class="bi bi-cash"></i>
                                            </button>
                                            <button class="btn-icon warning" onclick="checkInvestmentPayouts({{ investment.id }})" data-tooltip="Check Missed">
                                                <i class="bi bi-clock-history"></i>
                                            </button>
                                            {% if request.user.is_superuser %}
                                            <button class="btn-icon danger" onclick="forceCompleteInvestment({{ investment.id }})" data-tooltip="Force Complete">
                                                <i class="bi bi-x-octagon"></i>
                                            </button>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="12" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No investments found</h5>
                                        <p class="text-muted">Investments will appear here once users start investing.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                {% if investments_pagination and investments_pagination.total_pages > 1 %}
                <div class="pagination-wrapper">
                    <span class="text-muted">Page {{ investments_pagination.current_page }} of {{ investments_pagination.total_pages }}</span>
                    <nav>
                        <ul class="pagination">
                            {% if investments_pagination.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?investment_page={{ investments_pagination.current_page|add:-1 }}&investment_status={{ current_investment_status }}#investments">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">{{ investments_pagination.current_page }}</span>
                            </li>
                            
                            {% if investments_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?investment_page={{ investments_pagination.current_page|add:1 }}&investment_status={{ current_investment_status }}#investments">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Payouts Tab -->
        <div id="payouts" class="tab-pane {% if active_tab == 'payouts' %}active{% endif %}">
            <div class="table-header">
                <h4>Payout Management</h4>
                <div class="filter-group">
                    <button class="btn-action" onclick="checkAllPayouts()">
                        <i class="bi bi-clock-history me-2"></i>Check All
                    </button>
                    <button class="btn-action" onclick="catchUpAllPayouts()">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Catch Up All
                    </button>
                    <button class="btn-action" onclick="runDailyPayouts()">
                        <i class="bi bi-play-circle me-2"></i>Run Daily Payouts
                    </button>
                    <button class="btn-action" onclick="checkExpiredInvestments()">
                        <i class="bi bi-hourglass-split me-2"></i>Check Expired
                    </button>
                    <button class="btn-action" onclick="refreshPayoutStats()">
                        <i class="bi bi-arrow-repeat me-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Payout Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon payouts">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Due Today</span>
                        <div class="stat-value" id="payoutDueToday">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon payouts">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Missed Payouts</span>
                        <div class="stat-value" id="payoutMissed">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon payouts">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Processed Today</span>
                        <div class="stat-value" id="payoutProcessed">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon payouts">
                        <i class="bi bi-currency-exchange"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total Payouts</span>
                        <div class="stat-value">{{ dashboard_stats.total_profits_paid|floatformat:0|default:"0" }} <small>KSH</small></div>
                    </div>
                </div>
            </div>

            <!-- Payout Queue -->
            <div class="table-container">
                <h5 class="mb-3">Pending Payout Queue</h5>
                <div class="table-responsive">
                    <table class="modern-table" id="payoutsTable">
                        <thead>
                            <tr>
                                <th>Investment ID</th>
                                <th>User</th>
                                <th>Token</th>
                                <th>Amount Due</th>
                                <th>Last Payout</th>
                                <th>Due Since</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payoutsTableBody">
                            {% if pending_payouts %}
                                {% for payout in pending_payouts %}
                                <tr>
                                    <td><code>{{ payout.investment_id|truncatechars:8 }}</code></td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ payout.user|first|upper }}</div>
                                            <span>{{ payout.user }}</span>
                                        </div>
                                    </td>
                                    <td>{{ payout.token }}</td>
                                    <td class="amount-positive">{{ payout.amount }} KSH</td>
                                    <td>{{ payout.last_payout|default:"Never" }}</td>
                                    <td>{{ payout.due_since }}</td>
                                    <td>
                                        <span class="status-badge {% if payout.status == 'due' %}warning{% else %}pending{% endif %}">
                                            {{ payout.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn-icon payout" onclick="processPayout({{ payout.id }})" data-tooltip="Process Now">
                                            <i class="bi bi-cash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="bi bi-check-circle fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No pending payouts</h5>
                                        <p class="text-muted">All investments are up to date.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payout Logs -->
            <div class="table-container mt-4">
                <h5 class="mb-3">Recent Payout Activity</h5>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Investment</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_payouts %}
                                {% for payout in recent_payouts %}
                                <tr>
                                    <td><small>{{ payout.created_at }}</small></td>
                                    <td>{{ payout.user }}</td>
                                    <td><code>{{ payout.investment_id|truncatechars:8 }}</code></td>
                                    <td class="amount-positive">{{ payout.amount }} KSH</td>
                                    <td>
                                        <span class="status-badge verified">Completed</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="5" class="text-center">No recent payouts</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-pane {% if active_tab == 'users' %}active{% endif %}">
            <div class="table-header">
                <h4>User Management <span class="text-muted fs-6">({{ dashboard_stats.total_users|default:"0" }} total)</span></h4>
                <div class="filter-group">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="userSearch" placeholder="Search users...">
                    </div>
                    <select class="filter-select" id="userVerifiedFilter">
                        <option value="">All Status</option>
                        <option value="verified">Verified Only</option>
                        <option value="unverified">Unverified Only</option>
                    </select>
                    <select class="filter-select" id="userBannedFilter">
                        <option value="">All Users</option>
                        <option value="active">Active Only</option>
                        <option value="banned">Banned Only</option>
                    </select>
                    <select class="filter-select" id="userInvestorFilter">
                        <option value="">All Users</option>
                        <option value="investors">Has Investments</option>
                        <option value="non-investors">No Investments</option>
                    </select>
                    <button class="btn-action" onclick="filterUsers()">
                        <i class="bi bi-search"></i> Search
                    </button>
                    <button class="btn-action" onclick="exportData('users')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Balance</th>
                                <th>Locked</th>
                                <th>Available</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            {% if users_data %}
                                {% for user_data in users_data %}
                                <tr id="user-{{ user_data.id }}">
                                    <td>#{{ user_data.id }}</td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ user_data.first_name|first|default:user_data.username|first|upper }}</div>
                                            <div>
                                                <strong>{{ user_data.username }}</strong>
                                                <small class="d-block text-muted">{{ user_data.first_name }} {{ user_data.last_name }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ user_data.email }}</td>
                                    <td>{{ user_data.phone|default:"â" }}</td>
                                    <td class="amount">{{ user_data.balance|floatformat:2 }} KSH</td>
                                    <td class="amount-payout">{{ user_data.locked_balance|default:"0.00"|floatformat:2 }} KSH</td>
                                    <td class="{% if user_data.balance|add:"-"|add:user_data.locked_balance < 0 %}amount-negative{% else %}amount-positive{% endif %}">
                                        {{ user_data.balance|add:"-"|add:user_data.locked_balance|floatformat:2 }} KSH
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            {% if user_data.phone_verified %}
                                            <span class="badge bg-success" data-tooltip="Phone Verified"><i class="bi bi-check-circle"></i></span>
                                            {% else %}
                                            <span class="badge bg-secondary" data-tooltip="Phone Unverified"><i class="bi bi-x-circle"></i></span>
                                            {% endif %}
                                            {% if user_data.id_verified %}
                                            <span class="badge bg-success" data-tooltip="ID Verified"><i class="bi bi-shield-check"></i></span>
                                            {% else %}
                                            <span class="badge bg-secondary" data-tooltip="ID Unverified"><i class="bi bi-shield-x"></i></span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if user_data.is_banned %}
                                        <span class="status-badge rejected">Banned</span>
                                        {% else %}
                                        <span class="status-badge verified">Active</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ user_data.date_joined }}</small></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon info" onclick="viewUserDetails({{ user_data.id }})" data-tooltip="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn-icon warning" onclick="adjustBalance({{ user_data.id }})" data-tooltip="Adjust Balance">
                                                <i class="bi bi-cash"></i>
                                            </button>
                                            {% if user_data.is_banned %}
                                            <button class="btn-icon success" onclick="toggleUserBan({{ user_data.id }}, false)" data-tooltip="Unban">
                                                <i class="bi bi-unlock"></i>
                                            </button>
                                            {% else %}
                                            <button class="btn-icon danger" onclick="toggleUserBan({{ user_data.id }}, true)" data-tooltip="Ban">
                                                <i class="bi bi-lock"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn-icon" onclick="verifyUserKYC({{ user_data.id }})" data-tooltip="Verify KYC">
                                                <i class="bi bi-shield-check"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="11" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No users found</h5>
                                        <p class="text-muted">Users will appear here once they register.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                {% if users_pagination and users_pagination.total_pages > 1 %}
                <div class="pagination-wrapper">
                    <span class="text-muted">Page {{ users_pagination.current_page }} of {{ users_pagination.total_pages }}</span>
                    <nav>
                        <ul class="pagination">
                            {% if users_pagination.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?user_page={{ users_pagination.current_page|add:-1 }}&user_search={{ request.GET.user_search }}&user_verified={{ request.GET.user_verified }}&user_banned={{ request.GET.user_banned }}#users">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ users_pagination.current_page }}</span>
                            </li>
                            {% if users_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?user_page={{ users_pagination.current_page|add:1 }}&user_search={{ request.GET.user_search }}&user_verified={{ request.GET.user_verified }}&user_banned={{ request.GET.user_banned }}#users">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tokens Tab -->
        <div id="tokens" class="tab-pane {% if active_tab == 'tokens' %}active{% endif %}">
            <div class="table-header">
                <h4>Token Management</h4>
                <div class="filter-group">
                    <button class="btn-action" onclick="openTokenModal()">
                        <i class="bi bi-plus-circle me-2"></i>Create New Token
                    </button>
                    <button class="btn-action" onclick="exportData('tokens')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="tokensTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Display Name</th>
                                <th>Min Investment</th>
                                <th>Daily Return</th>
                                <th>Return Days</th>
                                <th>Total Return</th>
                                <th>ROI</th>
                                <th>Available</th>
                                <th>Max/User</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tokensTableBody">
                            {% if tokens_data %}
                                {% for token in tokens_data %}
                                <tr id="token-{{ token.id }}">
                                    <td><strong>{{ token.token_number }}</strong></td>
                                    <td><code>{{ token.name }}</code></td>
                                    <td>{{ token.display_name }}</td>
                                    <td class="amount">{{ token.minimum_investment|floatformat:0 }} KSH</td>
                                    <td class="amount-positive">{{ token.daily_return|floatformat:2 }} KSH</td>
                                    <td>{{ token.return_days }}</td>
                                    <td class="amount">{{ token.total_return|floatformat:2 }} KSH</td>
                                    <td>
                                        <span class="badge bg-success">{{ token.roi|floatformat:1 }}%</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress" style="width: 60px;">
                                                <div class="progress-bar" style="width: {% widthratio token.purchased_count token.total_supply|default:1 100 %}%"></div>
                                            </div>
                                            <small>{{ token.purchased_count }}/{{ token.total_supply|default:"â" }}</small>
                                        </div>
                                    </td>
                                    <td>{{ token.max_purchases_per_user|default:"1" }}</td>
                                    <td>
                                        <span class="status-badge 
                                            {% if token.status == 'ACTIVE' %}verified
                                            {% elif token.status == 'INACTIVE' %}pending
                                            {% elif token.status == 'COMING_SOON' %}processing
                                            {% elif token.status == 'SOLD_OUT' %}rejected
                                            {% endif %}">
                                            {{ token.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon primary" onclick="editToken({{ token.id }})" data-tooltip="Edit Token">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn-icon info" onclick="viewTokenDetails({{ token.id }})" data-tooltip="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if request.user.is_superuser %}
                                            <button class="btn-icon danger" onclick="toggleTokenStatus({{ token.id }})" data-tooltip="Toggle Status">
                                                <i class="bi bi-power"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="12" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No tokens found</h5>
                                        <p class="text-muted">Create your first token using the button above.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- KYC Tab -->
        <div id="kyc" class="tab-pane {% if active_tab == 'kyc' %}active{% endif %}">
            <div class="table-header">
                <h4>KYC Verification Requests <span class="badge bg-warning ms-2">{{ dashboard_stats.pending_kyc|default:"0" }}</span></h4>
                <div class="filter-group">
                    <button class="btn-action" onclick="exportData('kyc')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="kyc-grid" id="kycGrid">
                {% if kyc_pending_data %}
                    {% for kyc in kyc_pending_data %}
                    <div class="kyc-card" id="kyc-{{ kyc.id }}">
                        <div class="kyc-header">
                            <div class="user-cell">
                                <div class="user-avatar-sm">{{ kyc.username|first|upper }}</div>
                                <div>
                                    <h6 class="mb-0">{{ kyc.full_name }}</h6>
                                    <small class="text-muted">@{{ kyc.username }}</small>
                                </div>
                            </div>
                            <span class="status-badge pending">Pending</span>
                        </div>
                        
                        <p><i class="bi bi-phone me-2"></i>{{ kyc.phone }}</p>
                        
                        <div class="kyc-documents">
                            {% if kyc.has_id_front %}
                            <img src="{{ kyc.id_front_url }}" class="kyc-doc-preview" onclick="viewImage('{{ kyc.id_front_url }}')" alt="ID Front" title="ID Front">
                            {% else %}
                            <div class="kyc-doc-preview d-flex align-items-center justify-content-center bg-dark">No ID Front</div>
                            {% endif %}
                            {% if kyc.has_id_back %}
                            <img src="{{ kyc.id_back_url }}" class="kyc-doc-preview" onclick="viewImage('{{ kyc.id_back_url }}')" alt="ID Back" title="ID Back">
                            {% else %}
                            <div class="kyc-doc-preview d-flex align-items-center justify-content-center bg-dark">No ID Back</div>
                            {% endif %}
                            {% if kyc.has_selfie %}
                            <img src="{{ kyc.selfie_url }}" class="kyc-doc-preview" onclick="viewImage('{{ kyc.selfie_url }}')" alt="Selfie" title="Selfie">
                            {% else %}
                            <div class="kyc-doc-preview d-flex align-items-center justify-content-center bg-dark">No Selfie</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex gap-3 my-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="phoneVerify{{ kyc.id }}" {% if kyc.phone_verified %}checked{% endif %}>
                                <label class="form-check-label">Phone</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="idVerify{{ kyc.id }}" {% if kyc.id_verified %}checked{% endif %}>
                                <label class="form-check-label">ID</label>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn-action" style="flex: 1;" onclick="verifyKyc({{ kyc.id }})">
                                <i class="bi bi-check-all me-2"></i>Verify Selected
                            </button>
                            <button class="btn-action" style="flex: 1;" onclick="rejectKyc({{ kyc.id }})">
                                <i class="bi bi-x-lg me-2"></i>Reject
                            </button>
                        </div>
                        <div class="mt-2 text-muted small">
                            Submitted: {{ kyc.submitted_at }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-shield-check fs-1 text-muted"></i>
                        <p class="mt-3">No pending KYC requests</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-pane {% if active_tab == 'transactions' %}active{% endif %}">
            <div class="table-header">
                <h4>All Transactions</h4>
                <div class="filter-group">
                    <input type="text" class="date-range-picker" id="transactionDateRange" placeholder="Filter by date">
                    <select class="filter-select" id="transactionTypeFilter">
                        <option value="">All Types</option>
                        <option value="DEPOSIT">Deposits</option>
                        <option value="WITHDRAWAL">Withdrawals</option>
                        <option value="INVESTMENT">Investments</option>
                        <option value="PROFIT">Profits</option>
                        <option value="REFERRAL_BONUS">Referral Bonuses</option>
                        <option value="PENALTY">Penalties</option>
                        <option value="ADJUSTMENT">Adjustments</option>
                    </select>
                    <select class="filter-select" id="transactionStatusFilter">
                        <option value="">All Status</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="PENDING">Pending</option>
                        <option value="FAILED">Failed</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="transactionSearch" placeholder="Search...">
                    </div>
                    <button class="btn-action" onclick="filterTransactions()">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button class="btn-action" onclick="exportData('transactions')">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            {% if transactions_data %}
                                {% for transaction in transactions_data %}
                                <tr id="transaction-{{ transaction.id }}">
                                    <td><code>{{ transaction.transaction_id|truncatechars:12 }}</code></td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ transaction.user|first|upper }}</div>
                                            <div>
                                                <strong>{{ transaction.user }}</strong>
                                                <small class="d-block text-muted">ID: {{ transaction.user_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge 
                                            {% if transaction.type == 'DEPOSIT' %}verified
                                            {% elif transaction.type == 'WITHDRAWAL' %}processing
                                            {% elif transaction.type == 'PROFIT' %}success
                                            {% elif transaction.type == 'REFERRAL_BONUS' %}info
                                            {% elif transaction.type == 'PENALTY' %}rejected
                                            {% endif %}">
                                            {{ transaction.type }}
                                        </span>
                                    </td>
                                    <td class="amount 
                                        {% if transaction.type == 'WITHDRAWAL' or transaction.type == 'PENALTY' %}amount-negative
                                        {% else %}amount-positive{% endif %}">
                                        {% if transaction.type == 'WITHDRAWAL' or transaction.type == 'PENALTY' %}-{% else %}+{% endif %}
                                        {{ transaction.amount|floatformat:2 }} KSH
                                    </td>
                                    <td>
                                        <span data-tooltip="{{ transaction.description }}">
                                            {{ transaction.description|truncatechars:30 }}
                                        </span>
                                    </td>
                                    <td><small>{{ transaction.created_at }}</small></td>
                                    <td>
                                        <span class="status-badge 
                                            {% if transaction.status == 'COMPLETED' %}verified
                                            {% elif transaction.status == 'PENDING' %}pending
                                            {% elif transaction.status == 'FAILED' %}rejected
                                            {% endif %}">
                                            {{ transaction.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon info" onclick="viewTransactionDetails({{ transaction.id }})" data-tooltip="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if transaction.type == 'WITHDRAWAL' and transaction.status == 'PENDING' %}
                                            <button class="btn-icon success" onclick="completeWithdrawal({{ transaction.withdrawal_id }})" data-tooltip="Complete">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No transactions found</h5>
                                        <p class="text-muted">Transactions will appear here once users start using the platform.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                {% if transactions_pagination and transactions_pagination.total_pages > 1 %}
                <div class="pagination-wrapper">
                    <span class="text-muted">Page {{ transactions_pagination.current_page }} of {{ transactions_pagination.total_pages }}</span>
                    <nav>
                        <ul class="pagination">
                            {% if transactions_pagination.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?transaction_page={{ transactions_pagination.current_page|add:-1 }}&transaction_type={{ request.GET.transaction_type }}&transaction_status={{ request.GET.transaction_status }}#transactions">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ transactions_pagination.current_page }}</span>
                            </li>
                            {% if transactions_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?transaction_page={{ transactions_pagination.current_page|add:1 }}&transaction_type={{ request.GET.transaction_type }}&transaction_status={{ request.GET.transaction_status }}#transactions">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- System Logs Tab -->
        <div id="logs" class="tab-pane {% if active_tab == 'logs' %}active{% endif %}">
            <div class="table-header">
                <h4>System Logs</h4>
                <div class="filter-group">
                    <input type="text" class="date-range-picker" id="logDateRange" placeholder="Filter by date">
                    <select class="filter-select" id="logTypeFilter">
                        <option value="">All Types</option>
                        {% for type in log_type_choices %}
                        <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                    <select class="filter-select" id="logUserFilter">
                        <option value="">All Users</option>
                        {% if log_users %}
                            {% for user in log_users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="logSearch" placeholder="Search logs...">
                    </div>
                    <button class="btn-action" onclick="filterLogs()">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button class="btn-action" onclick="exportData('logs')">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="btn-action" onclick="clearLogs()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="modern-table" id="logsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Description</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            {% if logs_data %}
                                {% for log in logs_data %}
                                <tr>
                                    <td><small>{{ log.created_at }}</small></td>
                                    <td>
                                        <span class="status-badge 
                                            {% if log.type == 'ERROR' %}rejected
                                            {% elif log.type == 'WARNING' %}pending
                                            {% elif log.type == 'CRITICAL' %}danger
                                            {% else %}verified
                                            {% endif %}">
                                            {{ log.type }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar-sm">{{ log.user|first|upper }}</div>
                                            <span>{{ log.user }}</span>
                                        </div>
                                    </td>
                                    <td><code>{{ log.action }}</code></td>
                                    <td>{{ log.description }}</td>
                                    <td><small>{{ log.ip|default:"â" }}</small></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                        <h5>No logs found</h5>
                                        <p class="text-muted">System logs will appear here.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                {% if logs_pagination and logs_pagination.total_pages > 1 %}
                <div class="pagination-wrapper">
                    <span class="text-muted">Page {{ logs_pagination.current_page }} of {{ logs_pagination.total_pages }}</span>
                    <nav>
                        <ul class="pagination">
                            {% if logs_pagination.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?log_page={{ logs_pagination.current_page|add:-1 }}&log_type={{ request.GET.log_type }}#logs">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ logs_pagination.current_page }}</span>
                            </li>
                            {% if logs_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?log_page={{ logs_pagination.current_page|add:1 }}&log_type={{ request.GET.log_type }}#logs">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-pane {% if active_tab == 'settings' %}active{% endif %}">
            <div class="table-header">
                <h4>System Configuration</h4>
                <div class="filter-group">
                    <button class="btn-action" onclick="saveSettings()">
                        <i class="bi bi-save me-2"></i>Save All Changes
                    </button>
                    <button class="btn-action" onclick="resetSettings()">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Defaults
                    </button>
                </div>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="table-container">
                        <h5 class="mb-3">Deposit Settings</h5>
                        <div class="form-group">
                            <label>Minimum Deposit (KSH)</label>
                            <input type="number" class="form-control" id="config_min_deposit" value="{{ configs.min_deposit|default:'800' }}">
                        </div>
                        <div class="form-group">
                            <label>M-Pesa Paybill</label>
                            <input type="text" class="form-control" id="config_mpesa_paybill" value="{{ configs.mpesa_paybill|default:'123456' }}">
                        </div>
                        <div class="form-group">
                            <label>M-Pesa Account Number</label>
                            <input type="text" class="form-control" id="config_mpesa_account" value="{{ configs.mpesa_account|default:'INVEST' }}">
                        </div>
                    </div>
                    
                    <div class="table-container mt-4">
                        <h5 class="mb-3">Investment Settings</h5>
                        <div class="form-group">
                            <label>Default Return Days</label>
                            <input type="number" class="form-control" id="config_return_days" value="12">
                        </div>
                        <div class="form-group">
                            <label>Auto-Payout Enabled</label>
                            <select class="form-control" id="config_auto_payout">
                                <option value="1" selected>Enabled</option>
                                <option value="0">Disabled</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="table-container">
                        <h5 class="mb-3">Withdrawal Settings</h5>
                        <div class="form-group">
                            <label>Minimum Withdrawal (KSH)</label>
                            <input type="number" class="form-control" id="config_min_withdrawal" value="{{ configs.min_withdrawal|default:'200' }}">
                        </div>
                        <div class="form-group">
                            <label>Withdrawal Tax (%)</label>
                            <input type="number" step="0.1" class="form-control" id="config_withdrawal_tax" value="{{ configs.withdrawal_tax|default:'5' }}">
                        </div>
                        <div class="form-group">
                            <label>Processing Time (hours)</label>
                            <input type="number" class="form-control" id="config_processing_time" value="24">
                        </div>
                    </div>
                    
                    <div class="table-container mt-4">
                        <h5 class="mb-3">Referral Settings</h5>
                        <div class="form-group">
                            <label>Referral Commission (%)</label>
                            <input type="number" step="0.1" class="form-control" id="config_referral_commission" value="{{ configs.referral_commission|default:'5' }}">
                        </div>
                        <div class="form-group">
                            <label>Referral Bonus on First Deposit</label>
                            <input type="number" class="form-control" id="config_referral_bonus" value="100">
                        </div>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="table-container">
                        <h5 class="mb-3">Site Information</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Site Name</label>
                                    <input type="text" class="form-control" id="config_site_name" value="{{ configs.site_name|default:'XMR Investments' }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Support Email</label>
                                    <input type="email" class="form-control" id="config_support_email" value="{{ configs.support_email|default:'support@example.com' }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Support Phone</label>
                                    <input type="text" class="form-control" id="config_support_phone" value="{{ configs.support_phone|default:'0712345678' }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Currency</label>
                                    <select class="form-control" id="config_currency">
                                        <option value="KSH">KSH (Kenyan Shilling)</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ========== MODALS ========== -->

<!-- Token Modal (Create/Edit) -->
<div class="modal fade" id="tokenModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokenModalTitle">Create New Token</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="tokenForm">
                    <input type="hidden" id="tokenId" name="token_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Token Name <span class="text-muted">(e.g., XMR-1)</span></label>
                                <input type="text" class="form-control" id="tokenName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Display Name <span class="text-muted">(e.g., Monero Classic)</span></label>
                                <input type="text" class="form-control" id="tokenDisplayName" name="display_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Token Number (1-20)</label>
                                <input type="number" class="form-control" id="tokenNumber" name="token_number" min="1" max="20" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimum Investment (KSH)</label>
                                <input type="number" class="form-control" id="tokenMinInvestment" name="minimum_investment" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Daily Return (KSH)</label>
                                <input type="number" class="form-control" id="tokenDailyReturn" name="daily_return" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Return Days</label>
                                <input type="number" class="form-control" id="tokenReturnDays" name="return_days" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-control" id="tokenStatus" name="status">
                                    <option value="ACTIVE">Active</option>
                                    <option value="INACTIVE">Inactive</option>
                                    <option value="COMING_SOON">Coming Soon</option>
                                    <option value="SOLD_OUT">Sold Out</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Max Purchases/User</label>
                                <input type="number" class="form-control" id="tokenMaxPurchases" name="max_purchases_per_user" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Total Supply (Leave empty for unlimited)</label>
                                <input type="number" class="form-control" id="tokenTotalSupply" name="total_supply">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Color Theme</label>
                                <select class="form-control" id="tokenColor" name="color">
                                    <option value="primary">Blue</option>
                                    <option value="success">Green</option>
                                    <option value="warning">Orange</option>
                                    <option value="danger">Red</option>
                                    <option value="info">Light Blue</option>
                                    <option value="secondary">Gray</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="tokenDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Icon Class</label>
                        <input type="text" class="form-control" id="tokenIcon" name="icon" placeholder="bi bi-coin">
                        <small class="text-muted">Bootstrap Icons class name</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveToken()" style="background: #f15a24; border: none;">
                    <i class="bi bi-check-circle me-2"></i>Save Token
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="adjustBalance(currentUserId)" style="background: #f15a24; border: none;">
                    <i class="bi bi-cash me-2"></i>Adjust Balance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Adjust Balance Modal -->
<div class="modal fade" id="adjustBalanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust User Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustBalanceForm">
                    <input type="hidden" id="adjustUserId" name="user_id">
                    
                    <div class="form-group">
                        <label>Amount (KSH)</label>
                        <input type="number" class="form-control" id="adjustAmount" name="amount" step="0.01" required>
                        <small class="text-muted">Use positive to add, negative to subtract</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" id="adjustDescription" name="description" value="Admin adjustment">
                    </div>
                    
                    <div class="form-group">
                        <label>Adjustment Type</label>
                        <select class="form-control" id="adjustType">
                            <option value="add">Add to Balance</option>
                            <option value="subtract">Subtract from Balance</option>
                            <option value="lock">Add to Locked Balance</option>
                            <option value="unlock">Unlock from Locked</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitBalanceAdjustment()" style="background: #f15a24; border: none;">
                    <i class="bi bi-check-circle me-2"></i>Adjust Balance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Investment Details Modal -->
<div class="modal fade" id="investmentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Investment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="investmentDetailsContent">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="processPayout(currentInvestmentId)">
                    <i class="bi bi-cash me-2"></i>Process Payout
                </button>
                <button type="button" class="btn btn-warning" onclick="checkInvestmentPayouts(currentInvestmentId)">
                    <i class="bi bi-clock-history me-2"></i>Check Missed
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetailsContent">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="previewImage" class="img-fluid" alt="Document" style="max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="downloadImageBtn" class="btn btn-primary" download>Download</a>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalMessage">
                Are you sure?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- System Status Modal -->
<div class="modal fade" id="systemStatusModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Health Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="systemStatusContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Checking system health...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshSystemStatus()" style="background: #f15a24; border: none;">
                    <i class="bi bi-arrow-repeat me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Maintenance Menu Modal -->
<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Maintenance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="runMaintenance('fix_wallets')">
                        <i class="bi bi-wrench me-3 fs-4"></i>
                        <div>
                            <strong>Fix All Wallets</strong>
                            <small class="d-block text-muted">Recalculate and fix wallet balances</small>
                        </div>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="runMaintenance('check_expired')">
                        <i class="bi bi-hourglass-split me-3 fs-4"></i>
                        <div>
                            <strong>Check Expired Investments</strong>
                            <small class="d-block text-muted">Mark expired investments as completed</small>
                        </div>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="runMaintenance('run_payouts')">
                        <i class="bi bi-cash-stack me-3 fs-4"></i>
                        <div>
                            <strong>Run Daily Payouts</strong>
                            <small class="d-block text-muted">Process all due payouts</small>
                        </div>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="runMaintenance('catch_up_payouts')">
                        <i class="bi bi-lightning-charge me-3 fs-4"></i>
                        <div>
                            <strong>Catch Up All Payouts</strong>
                            <small class="d-block text-muted">Process all missed payouts</small>
                        </div>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="runMaintenance('clear_logs')">
                        <i class="bi bi-trash me-3 fs-4"></i>
                        <div>
                            <strong>Clear Old Logs</strong>
                            <small class="d-block text-muted">Remove logs older than 30 days</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.min.js"></script>

<script>
    // ========== GLOBAL VARIABLES ==========
    let currentTab = '{{ active_tab|default:"dashboard" }}';
    let chartInstance = null;
    let tokenModal = null;
    let userDetailsModal = null;
    let adjustBalanceModal = null;
    let investmentDetailsModal = null;
    let transactionDetailsModal = null;
    let imagePreviewModal = null;
    let confirmModal = null;
    let systemStatusModal = null;
    let maintenanceModal = null;
    let currentAction = null;
    let currentItemId = null;
    let currentUserId = null;
    let currentInvestmentId = null;
    let currentItemData = null;

    // API URLs from Django
    const API_URL = '{% url "XMR:admin_api" %}';
    const CATCH_UP_URL = '{% url "XMR:admin_catch_up_payouts" %}';
    const PAYOUT_STATS_URL = '{% url "XMR:admin_payout_stats" %}';
    const SYSTEM_STATUS_URL = '{% url "XMR:admin_system_status" %}';
    const FIX_WALLETS_URL = '{% url "XMR:fix_all_wallets" %}';
    const EXPORT_USERS_URL = '{% url "XMR:export_users_csv" %}';
    const EXPORT_TRANSACTIONS_URL = '{% url "XMR:export_transactions_csv" %}';
    const CSRF_TOKEN = '{{ csrf_token }}';

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap modals
        tokenModal = new bootstrap.Modal(document.getElementById('tokenModal'));
        userDetailsModal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
        adjustBalanceModal = new bootstrap.Modal(document.getElementById('adjustBalanceModal'));
        investmentDetailsModal = new bootstrap.Modal(document.getElementById('investmentDetailsModal'));
        transactionDetailsModal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
        imagePreviewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
        confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        systemStatusModal = new bootstrap.Modal(document.getElementById('systemStatusModal'));
        maintenanceModal = new bootstrap.Modal(document.getElementById('maintenanceModal'));

        // Initialize Select2
        $('.filter-select').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });

        // Initialize Date Range Pickers
        $('.date-range-picker').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear',
                format: 'YYYY-MM-DD'
            },
            ranges: {
                'Today': [moment(), moment()],
                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        });

        $('.date-range-picker').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('YYYY-MM-DD') + ' to ' + picker.endDate.format('YYYY-MM-DD'));
        });

        $('.date-range-picker').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
        });

        // Load daily deposits chart if on dashboard
        if (document.getElementById('depositsChart')) {
            loadDepositsChart();
        }

        // Add event listeners
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Check if we need to switch to a tab from URL hash
        if (window.location.hash) {
            const tabId = window.location.hash.substring(1);
            if (document.getElementById(tabId)) {
                switchTab(tabId);
            }
        }
        
        // Load initial payout stats
        refreshPayoutStats();
        refreshSystemHealth();
        
        // Set up periodic refresh
        setInterval(refreshPayoutStats, 30000);
        setInterval(refreshSystemHealth, 60000);
    });

    // ========== THEME TOGGLE ==========
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        html.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('admin-theme', newTheme);
        
        // Update chart colors if chart exists
        if (chartInstance) {
            chartInstance.destroy();
            loadDepositsChart();
        }
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('admin-theme') || 'dark';
    document.documentElement.setAttribute('data-bs-theme', savedTheme);

    // ========== TAB SWITCHING ==========
    function switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const selectedTab = document.getElementById(tabId);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        
        document.querySelectorAll('.nav-link-sidebar').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = Array.from(document.querySelectorAll('.nav-link-sidebar')).find(
            link => link.textContent.toLowerCase().includes(tabId.replace(/-/g, ' '))
        );
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        window.location.hash = tabId;
        currentTab = tabId;
        
        // Refresh data for specific tabs
        if (tabId === 'payouts') {
            refreshPayoutStats();
        } else if (tabId === 'dashboard') {
            refreshDashboard();
        }
    }

    // ========== CHART LOADING ==========
    function loadDepositsChart() {
        const canvas = document.getElementById('depositsChart');
        if (!canvas) return;
        
        {% if daily_deposits %}
        const dailyDeposits = {{ daily_deposits|safe }};
        {% else %}
        const dailyDeposits = [];
        {% endif %}
        
        if (chartInstance) {
            chartInstance.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dailyDeposits.map(d => d.date),
                datasets: [{
                    label: 'Deposits (KSH)',
                    data: dailyDeposits.map(d => d.total),
                    borderColor: '#f15a24',
                    backgroundColor: 'rgba(241, 90, 36, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#f15a24',
                    pointBorderColor: isDark ? '#1e293b' : '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? '#1e293b' : '#ffffff',
                        titleColor: isDark ? '#f1f5f9' : '#1e293b',
                        bodyColor: isDark ? '#94a3b8' : '#64748b',
                        borderColor: '#f15a24',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `KSH ${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                            color: isDark ? '#94a3b8' : '#64748b',
                            callback: function(value) {
                                return 'KSH ' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: isDark ? '#94a3b8' : '#64748b',
                        }
                    }
                }
            }
        });
    }

    function refreshChart() {
        if (chartInstance) {
            chartInstance.destroy();
        }
        loadDepositsChart();
        showToast('Chart refreshed', 'success');
    }

    function refreshDashboard() {
        refreshPayoutStats();
        refreshChart();
    }

    // ========== TOAST NOTIFICATIONS ==========
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const icon = type === 'success' ? 'bi-check-circle-fill' : 
                    type === 'error' ? 'bi-exclamation-circle-fill' : 
                    type === 'warning' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';
        
        const bgClass = `toast-${type}`;
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast ${bgClass}`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="toast-body">
                <i class="bi ${icon}"></i>
                <span>${message}</span>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }

    // ========== LOADING SPINNER ==========
    function showLoading(message = 'Processing...') {
        document.getElementById('loadingText').textContent = message;
        document.getElementById('loadingSpinner').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // ========== API CALLS ==========
    async function apiCall(action, data, method = 'POST') {
        showLoading();
        
        const formData = new FormData();
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', CSRF_TOKEN);
        
        for (let key in data) {
            formData.append(key, data[key]);
        }
        
        try {
            const response = await fetch(API_URL, {
                method: method,
                body: formData,
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                showToast(result.message || 'Action completed successfully', 'success');
            } else {
                showToast(result.error || 'An error occurred', 'error');
            }
            
            return result;
        } catch (error) {
            hideLoading();
            showToast('Network error: ' + error.message, 'error');
            console.error('API Error:', error);
            return { success: false, error: error.message };
        }
    }

    // ========== NOTIFICATION COUNTS ==========
    function updateNotificationCounts() {
        const deposits = document.querySelectorAll('#depositsTableBody tr .status-badge.pending').length;
        const withdrawals = document.querySelectorAll('#withdrawalsTableBody tr .status-badge.pending').length;
        const kyc = document.querySelectorAll('.kyc-card').length;
        
        const total = deposits + withdrawals + kyc;
        
        document.getElementById('notificationCount').textContent = total;
        document.getElementById('pendingDepositsCount').textContent = deposits;
        document.getElementById('pendingWithdrawalsCount').textContent = withdrawals;
        document.getElementById('pendingKycCount').textContent = kyc;
        
        document.getElementById('sidebarDepositsCount').textContent = deposits;
        document.getElementById('sidebarWithdrawalsCount').textContent = withdrawals;
        document.getElementById('sidebarKycCount').textContent = kyc;
    }

    function refreshNotifications() {
        updateNotificationCounts();
        showToast('Notifications updated', 'success');
    }

    // ========== DEPOSIT ACTIONS ==========
    function filterDeposits() {
        const status = document.getElementById('depositStatusFilter').value;
        const dateRange = document.getElementById('depositDateRange').value;
        const search = document.getElementById('depositSearch').value;
        
        let url = `?deposit_status=${status}#deposits`;
        if (dateRange) url += `&date_range=${encodeURIComponent(dateRange)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        window.location.href = url;
    }

    async function verifyDeposit(depositId) {
        document.getElementById('confirmModalTitle').textContent = 'Verify Deposit';
        document.getElementById('confirmModalMessage').innerHTML = `
            <p>Are you sure you want to verify this deposit?</p>
            <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> This will add funds to the user's wallet.</p>
        `;
        document.getElementById('confirmModalBtn').className = 'btn btn-success';
        document.getElementById('confirmModalBtn').textContent = 'Verify';
        
        currentAction = 'verifyDeposit';
        currentItemId = depositId;
        confirmModal.show();
    }

    async function rejectDeposit(depositId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) return;
        
        document.getElementById('confirmModalTitle').textContent = 'Reject Deposit';
        document.getElementById('confirmModalMessage').textContent = `Reject deposit with reason: ${reason}`;
        document.getElementById('confirmModalBtn').className = 'btn btn-danger';
        document.getElementById('confirmModalBtn').textContent = 'Reject';
        
        currentAction = 'rejectDeposit';
        currentItemId = depositId;
        currentItemData = { reason: reason };
        confirmModal.show();
    }

    function viewDepositDetails(depositId) {
        const row = document.getElementById(`deposit-${depositId}`);
        if (!row) return;
        
        const cells = row.cells;
        const depositData = {
            id: depositId,
            userId: cells[1].querySelector('small').textContent.replace('ID: ', ''),
            username: cells[1].querySelector('strong').textContent,
            amount: cells[2].textContent,
            phone: cells[3].textContent,
            code: cells[4].textContent,
            date: cells[5].textContent,
            status: cells[6].textContent.trim()
        };
        
        // You can implement a detailed view modal here
        showToast(`Deposit #${depositId}: ${depositData.amount}`, 'info');
    }

    // ========== WITHDRAWAL ACTIONS ==========
    function filterWithdrawals() {
        const status = document.getElementById('withdrawalStatusFilter').value;
        const method = document.getElementById('withdrawalMethodFilter').value;
        const dateRange = document.getElementById('withdrawalDateRange').value;
        const search = document.getElementById('withdrawalSearch').value;
        
        let url = `?withdrawal_status=${status}&withdrawal_method=${method}#withdrawals`;
        if (dateRange) url += `&date_range=${encodeURIComponent(dateRange)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        window.location.href = url;
    }

    async function processWithdrawal(withdrawalId) {
        document.getElementById('confirmModalTitle').textContent = 'Process Withdrawal';
        document.getElementById('confirmModalMessage').textContent = 'Mark this withdrawal as processing?';
        document.getElementById('confirmModalBtn').className = 'btn btn-info';
        document.getElementById('confirmModalBtn').textContent = 'Process';
        
        currentAction = 'processWithdrawal';
        currentItemId = withdrawalId;
        confirmModal.show();
    }

    async function completeWithdrawal(withdrawalId) {
        const transactionCode = prompt('Enter transaction code (M-Pesa/Bank):');
        if (!transactionCode) return;
        
        document.getElementById('confirmModalTitle').textContent = 'Complete Withdrawal';
        document.getElementById('confirmModalMessage').textContent = `Complete withdrawal with code: ${transactionCode}`;
        document.getElementById('confirmModalBtn').className = 'btn btn-success';
        document.getElementById('confirmModalBtn').textContent = 'Complete';
        
        currentAction = 'completeWithdrawal';
        currentItemId = withdrawalId;
        currentItemData = { code: transactionCode };
        confirmModal.show();
    }

    async function rejectWithdrawal(withdrawalId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) return;
        
        document.getElementById('confirmModalTitle').textContent = 'Reject Withdrawal';
        document.getElementById('confirmModalMessage').textContent = `Reject withdrawal with reason: ${reason}`;
        document.getElementById('confirmModalBtn').className = 'btn btn-danger';
        document.getElementById('confirmModalBtn').textContent = 'Reject';
        
        currentAction = 'rejectWithdrawal';
        currentItemId = withdrawalId;
        currentItemData = { reason: reason };
        confirmModal.show();
    }

    function viewWithdrawalDetails(withdrawalId) {
        const row = document.getElementById(`withdrawal-${withdrawalId}`);
        if (!row) return;
        
        const cells = row.cells;
        const withdrawalData = {
            id: withdrawalId,
            requestId: cells[0].textContent,
            userId: cells[1].querySelector('small').textContent.replace('ID: ', ''),
            username: cells[1].querySelector('strong').textContent,
            amount: cells[2].textContent,
            net: cells[3].textContent,
            tax: cells[4].textContent,
            method: cells[5].textContent,
            details: cells[6].textContent,
            date: cells[7].textContent,
            status: cells[8].textContent.trim()
        };
        
        showToast(`Withdrawal #${withdrawalId}: ${withdrawalData.amount} (${withdrawalData.status})`, 'info');
    }

    // ========== INVESTMENT ACTIONS ==========
    function filterInvestments() {
        const status = document.getElementById('investmentStatusFilter').value;
        const token = document.getElementById('investmentTokenFilter').value;
        const dateRange = document.getElementById('investmentDateRange').value;
        const search = document.getElementById('investmentSearch').value;
        
        let url = `?investment_status=${status}&investment_token=${token}#investments`;
        if (dateRange) url += `&date_range=${encodeURIComponent(dateRange)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        window.location.href = url;
    }

    function viewInvestmentDetails(investmentId) {
        currentInvestmentId = investmentId;
        const row = document.getElementById(`investment-${investmentId}`);
        if (!row) return;
        
        const cells = row.cells;
        const investmentData = {
            id: investmentId,
            investmentId: cells[0].textContent,
            userId: cells[1].querySelector('small').textContent.replace('ID: ', ''),
            username: cells[1].querySelector('strong').textContent,
            token: cells[2].textContent,
            amount: cells[3].textContent,
            dailyReturn: cells[4].textContent,
            progress: cells[5].querySelector('small').textContent,
            totalPaid: cells[6].textContent,
            remaining: cells[7].textContent,
            startDate: cells[8].textContent,
            lastPayout: cells[9].textContent,
            status: cells[10].textContent.trim()
        };
        
        document.getElementById('investmentDetailsContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">Investment ID:</td>
                            <td class="fw-bold">${investmentData.investmentId}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">User:</td>
                            <td class="fw-bold">${investmentData.username}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">User ID:</td>
                            <td>${investmentData.userId}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Token:</td>
                            <td>${investmentData.token}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Amount:</td>
                            <td class="amount">${investmentData.amount}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Daily Return:</td>
                            <td class="amount-positive">${investmentData.dailyReturn}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">Progress:</td>
                            <td>${investmentData.progress}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Total Paid:</td>
                            <td class="amount-positive">${investmentData.totalPaid}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Remaining Payouts:</td>
                            <td class="amount-payout">${investmentData.remaining}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Start Date:</td>
                            <td>${investmentData.startDate}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Last Payout:</td>
                            <td>${investmentData.lastPayout}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td><span class="status-badge ${investmentData.status === 'ACTIVE' ? 'verified' : 'success'}">${investmentData.status}</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        investmentDetailsModal.show();
    }

    async function processPayout(investmentId) {
        document.getElementById('confirmModalTitle').textContent = 'Process Payout';
        document.getElementById('confirmModalMessage').textContent = 'Process a single payout for this investment?';
        document.getElementById('confirmModalBtn').className = 'btn btn-success';
        document.getElementById('confirmModalBtn').textContent = 'Process';
        
        currentAction = 'processPayout';
        currentItemId = investmentId;
        confirmModal.show();
    }

    async function checkInvestmentPayouts(investmentId) {
        showLoading('Checking for missed payouts...');
        try {
            const result = await apiCall('check_investment_payouts', {
                investment_id: investmentId
            });
            
            if (result.success && result.missed > 0) {
                showToast(`Found ${result.missed} missed payouts. Processing...`, 'info');
                setTimeout(() => location.reload(), 2000);
            } else if (result.success) {
                showToast('No missed payouts found', 'success');
            }
        } catch (error) {
            hideLoading();
            showToast('Error checking payouts', 'error');
        }
    }

    async function forceCompleteInvestment(investmentId) {
        document.getElementById('confirmModalTitle').textContent = 'â ï¸ Force Complete Investment';
        document.getElementById('confirmModalMessage').innerHTML = `
            <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> This will forcefully complete the investment and return principal.</p>
            <p>Are you absolutely sure?</p>
        `;
        document.getElementById('confirmModalBtn').className = 'btn btn-danger';
        document.getElementById('confirmModalBtn').textContent = 'Force Complete';
        
        currentAction = 'forceCompleteInvestment';
        currentItemId = investmentId;
        confirmModal.show();
    }

    // ========== PAYOUT ACTIONS ==========
    async function checkAllPayouts() {
        showLoading('Checking all payouts...');
        try {
            const response = await fetch(PAYOUT_STATS_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                },
                credentials: 'same-origin'
            });
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                document.getElementById('dueTodayCount').textContent = result.due_for_payout || 0;
                document.getElementById('missedCount').textContent = result.missed || 0;
                document.getElementById('processedToday').textContent = result.payouts_last_24h || 0;
                
                if (document.getElementById('payoutDueToday')) {
                    document.getElementById('payoutDueToday').textContent = result.due_for_payout || 0;
                    document.getElementById('payoutMissed').textContent = result.missed || 0;
                    document.getElementById('payoutProcessed').textContent = result.payouts_last_24h || 0;
                }
                
                showToast(`Found ${result.due_for_payout} payouts due today`, 'info');
            } else {
                showToast(result.error || 'Error checking payouts', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast('Error checking payouts: ' + error.message, 'error');
        }
    }

    async function catchUpAllPayouts() {
        document.getElementById('confirmModalTitle').textContent = 'Catch Up All Payouts';
        document.getElementById('confirmModalMessage').innerHTML = `
            <p>This will process ALL missed payouts for ALL users.</p>
            <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> This may take a while for large systems.</p>
            <p>Continue?</p>
        `;
        document.getElementById('confirmModalBtn').className = 'btn btn-warning';
        document.getElementById('confirmModalBtn').textContent = 'Process All';
        
        currentAction = 'catchUpAllPayouts';
        confirmModal.show();
    }

    async function runDailyPayouts() {
        document.getElementById('confirmModalTitle').textContent = 'Run Daily Payouts';
        document.getElementById('confirmModalMessage').textContent = 'Process all due payouts for today?';
        document.getElementById('confirmModalBtn').className = 'btn btn-primary';
        document.getElementById('confirmModalBtn').textContent = 'Run';
        
        currentAction = 'runDailyPayouts';
        confirmModal.show();
    }

    async function checkExpiredInvestments() {
        document.getElementById('confirmModalTitle').textContent = 'Check Expired Investments';
        document.getElementById('confirmModalMessage').textContent = 'Mark all expired investments as completed?';
        document.getElementById('confirmModalBtn').className = 'btn btn-info';
        document.getElementById('confirmModalBtn').textContent = 'Check';
        
        currentAction = 'checkExpiredInvestments';
        confirmModal.show();
    }

    async function refreshPayoutStats() {
        try {
            const response = await fetch(PAYOUT_STATS_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                },
                credentials: 'same-origin'
            });
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('dueTodayCount').textContent = result.due_for_payout || 0;
                document.getElementById('missedCount').textContent = result.missed || 0;
                document.getElementById('processedToday').textContent = result.payouts_last_24h || 0;
                
                if (document.getElementById('payoutDueToday')) {
                    document.getElementById('payoutDueToday').textContent = result.due_for_payout || 0;
                    document.getElementById('payoutMissed').textContent = result.missed || 0;
                    document.getElementById('payoutProcessed').textContent = result.payouts_last_24h || 0;
                }
            }
        } catch (error) {
            console.error('Error refreshing payout stats:', error);
        }
    }

    // ========== USER ACTIONS ==========
    function filterUsers() {
        const search = document.getElementById('userSearch').value;
        const verified = document.getElementById('userVerifiedFilter').value;
        const banned = document.getElementById('userBannedFilter').value;
        const investor = document.getElementById('userInvestorFilter').value;
        
        let url = `?user_search=${search}&user_verified=${verified}&user_banned=${banned}&user_investor=${investor}#users`;
        window.location.href = url;
    }

    function viewUserDetails(userId) {
        currentUserId = userId;
        const row = document.getElementById(`user-${userId}`);
        if (!row) return;
        
        const cells = row.cells;
        const userData = {
            id: userId,
            username: cells[1].querySelector('strong').textContent,
            fullName: cells[1].querySelector('small').textContent,
            email: cells[2].textContent,
            phone: cells[3].textContent,
            balance: cells[4].textContent,
            locked: cells[5].textContent,
            available: cells[6].textContent,
            phoneVerified: cells[7].querySelectorAll('.badge')[0]?.classList.contains('bg-success') || false,
            idVerified: cells[7].querySelectorAll('.badge')[1]?.classList.contains('bg-success') || false,
            status: cells[8].textContent.trim(),
            joined: cells[9].textContent
        };
        
        document.getElementById('userDetailsContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">User ID:</td>
                            <td class="fw-bold">#${userData.id}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Username:</td>
                            <td class="fw-bold">${userData.username}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Full Name:</td>
                            <td>${userData.fullName}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Email:</td>
                            <td>${userData.email}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Phone:</td>
                            <td>${userData.phone || 'â'}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">Balance:</td>
                            <td class="amount">${userData.balance}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Locked Balance:</td>
                            <td class="amount-payout">${userData.locked}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Available Balance:</td>
                            <td class="${userData.available.includes('-') ? 'amount-negative' : 'amount-positive'}">${userData.available}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Verification:</td>
                            <td>
                                ${userData.phoneVerified ? '<span class="badge bg-success me-1">Phone</span>' : ''}
                                ${userData.idVerified ? '<span class="badge bg-success">ID</span>' : ''}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td><span class="status-badge ${userData.status === 'Active' ? 'verified' : 'rejected'}">${userData.status}</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Joined:</td>
                            <td>${userData.joined}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        userDetailsModal.show();
    }

    function adjustBalance(userId) {
        currentUserId = userId;
        document.getElementById('adjustUserId').value = userId;
        document.getElementById('adjustAmount').value = '';
        document.getElementById('adjustDescription').value = 'Admin adjustment';
        document.getElementById('adjustType').value = 'add';
        adjustBalanceModal.show();
    }

    async function submitBalanceAdjustment() {
        const userId = document.getElementById('adjustUserId').value;
        const amount = document.getElementById('adjustAmount').value;
        const description = document.getElementById('adjustDescription').value;
        const adjustType = document.getElementById('adjustType').value;
        
        if (!amount) {
            showToast('Please enter an amount', 'error');
            return;
        }
        
        let actualAmount = parseFloat(amount);
        if (adjustType === 'subtract') {
            actualAmount = -actualAmount;
        }
        
        const result = await apiCall('adjust_balance', {
            user_id: userId,
            amount: actualAmount,
            description: description,
            adjust_type: adjustType
        });
        
        if (result.success) {
            adjustBalanceModal.hide();
            // Update the row
            const balanceCell = document.querySelector(`#user-${userId} td:nth-child(5)`);
            const lockedCell = document.querySelector(`#user-${userId} td:nth-child(6)`);
            const availableCell = document.querySelector(`#user-${userId} td:nth-child(7)`);
            
            if (balanceCell && result.new_balance !== undefined) {
                balanceCell.textContent = parseFloat(result.new_balance).toFixed(2) + ' KSH';
            }
            if (lockedCell && result.new_locked !== undefined) {
                lockedCell.textContent = parseFloat(result.new_locked).toFixed(2) + ' KSH';
            }
            if (balanceCell && lockedCell && availableCell) {
                const newBalance = parseFloat(result.new_balance || balanceCell.textContent);
                const newLocked = parseFloat(result.new_locked || lockedCell.textContent);
                const available = newBalance - newLocked;
                availableCell.textContent = available.toFixed(2) + ' KSH';
                availableCell.className = available < 0 ? 'amount-negative' : 'amount-positive';
            }
        }
    }

    async function toggleUserBan(userId, ban) {
        const reason = ban ? prompt('Enter ban reason:') : '';
        if (ban && !reason) return;
        
        document.getElementById('confirmModalTitle').textContent = ban ? 'Ban User' : 'Unban User';
        document.getElementById('confirmModalMessage').textContent = ban ? 
            `Ban user with reason: ${reason}` : 
            'Unban this user?';
        document.getElementById('confirmModalBtn').className = ban ? 'btn btn-danger' : 'btn btn-success';
        document.getElementById('confirmModalBtn').textContent = ban ? 'Ban' : 'Unban';
        
        currentAction = 'toggleUserBan';
        currentItemId = userId;
        currentItemData = { ban: ban, reason: reason };
        confirmModal.show();
    }

    function verifyUserKYC(userId) {
        switchTab('kyc');
        showToast('Navigate to KYC tab to verify documents', 'info');
    }

    // ========== TOKEN ACTIONS ==========
    function openTokenModal() {
        document.getElementById('tokenModalTitle').textContent = 'Create New Token';
        document.getElementById('tokenForm').reset();
        document.getElementById('tokenId').value = '';
        document.getElementById('tokenNumber').value = '';
        document.getElementById('tokenMinInvestment').value = '800';
        document.getElementById('tokenReturnDays').value = '12';
        document.getElementById('tokenMaxPurchases').value = '1';
        document.getElementById('tokenStatus').value = 'ACTIVE';
        document.getElementById('tokenColor').value = 'primary';
        tokenModal.show();
    }

    function editToken(tokenId) {
        const tokenRow = document.getElementById(`token-${tokenId}`);
        if (!tokenRow) return;
        
        const cells = tokenRow.cells;
        
        document.getElementById('tokenModalTitle').textContent = 'Edit Token';
        document.getElementById('tokenId').value = tokenId;
        document.getElementById('tokenName').value = cells[1].textContent.trim();
        document.getElementById('tokenDisplayName').value = cells[2].textContent.trim();
        document.getElementById('tokenNumber').value = cells[0].textContent.trim();
        document.getElementById('tokenMinInvestment').value = parseFloat(cells[3].textContent);
        document.getElementById('tokenDailyReturn').value = parseFloat(cells[4].textContent);
        document.getElementById('tokenReturnDays').value = parseInt(cells[5].textContent);
        document.getElementById('tokenStatus').value = cells[10].textContent.trim();
        document.getElementById('tokenMaxPurchases').value = parseInt(cells[9].textContent) || 1;
        
        const supplyText = cells[8].textContent.trim();
        const supply = supplyText.split('/')[1];
        document.getElementById('tokenTotalSupply').value = supply === 'â' ? '' : supply;
        
        tokenModal.show();
    }

    async function saveToken() {
        const formData = {
            name: document.getElementById('tokenName').value,
            display_name: document.getElementById('tokenDisplayName').value,
            token_number: document.getElementById('tokenNumber').value,
            minimum_investment: document.getElementById('tokenMinInvestment').value,
            daily_return: document.getElementById('tokenDailyReturn').value,
            return_days: document.getElementById('tokenReturnDays').value,
            status: document.getElementById('tokenStatus').value,
            max_purchases_per_user: document.getElementById('tokenMaxPurchases').value,
            total_supply: document.getElementById('tokenTotalSupply').value || '',
            description: document.getElementById('tokenDescription').value,
            icon: document.getElementById('tokenIcon').value || 'bi-coin',
            color: document.getElementById('tokenColor').value
        };
        
        const tokenId = document.getElementById('tokenId').value;
        const action = tokenId ? 'update_token' : 'create_token';
        
        if (tokenId) {
            formData.token_id = tokenId;
        }
        
        const result = await apiCall(action, formData);
        
        if (result.success) {
            tokenModal.hide();
            setTimeout(() => location.reload(), 1500);
        }
    }

    function viewTokenDetails(tokenId) {
        const tokenRow = document.getElementById(`token-${tokenId}`);
        if (!tokenRow) return;
        
        const cells = tokenRow.cells;
        showToast(`Token ${cells[1].textContent}: ${cells[3].textContent} min, ${cells[4].textContent} daily`, 'info');
    }

    async function toggleTokenStatus(tokenId) {
        const tokenRow = document.getElementById(`token-${tokenId}`);
        if (!tokenRow) return;
        
        const currentStatus = tokenRow.cells[10].textContent.trim();
        const newStatus = currentStatus === 'ACTIVE' ? 'INACTIVE' : 'ACTIVE';
        
        document.getElementById('confirmModalTitle').textContent = 'Toggle Token Status';
        document.getElementById('confirmModalMessage').textContent = `Change token status from ${currentStatus} to ${newStatus}?`;
        document.getElementById('confirmModalBtn').className = 'btn btn-warning';
        document.getElementById('confirmModalBtn').textContent = 'Toggle';
        
        currentAction = 'toggleTokenStatus';
        currentItemId = tokenId;
        currentItemData = { status: newStatus };
        confirmModal.show();
    }

    // ========== KYC ACTIONS ==========
    async function verifyKyc(profileId) {
        const phoneVerified = document.getElementById(`phoneVerify${profileId}`)?.checked || false;
        const idVerified = document.getElementById(`idVerify${profileId}`)?.checked || false;
        
        if (!phoneVerified && !idVerified) {
            showToast('Please select at least one verification option', 'warning');
            return;
        }
        
        document.getElementById('confirmModalTitle').textContent = 'Verify KYC';
        document.getElementById('confirmModalMessage').innerHTML = `
            Verify:
            ${phoneVerified ? '<br>- Phone' : ''}
            ${idVerified ? '<br>- ID' : ''}
        `;
        document.getElementById('confirmModalBtn').className = 'btn btn-success';
        document.getElementById('confirmModalBtn').textContent = 'Verify';
        
        currentAction = 'verifyKyc';
        currentItemId = profileId;
        currentItemData = { phone: phoneVerified, id: idVerified };
        confirmModal.show();
    }

    function rejectKyc(profileId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) return;
        
        document.getElementById('confirmModalTitle').textContent = 'Reject KYC';
        document.getElementById('confirmModalMessage').textContent = `Reject with reason: ${reason}`;
        document.getElementById('confirmModalBtn').className = 'btn btn-danger';
        document.getElementById('confirmModalBtn').textContent = 'Reject';
        
        currentAction = 'rejectKyc';
        currentItemId = profileId;
        currentItemData = { reason: reason };
        confirmModal.show();
    }

    // ========== TRANSACTIONS ACTIONS ==========
    function filterTransactions() {
        const type = document.getElementById('transactionTypeFilter').value;
        const status = document.getElementById('transactionStatusFilter').value;
        const dateRange = document.getElementById('transactionDateRange').value;
        const search = document.getElementById('transactionSearch').value;
        
        let url = `?transaction_type=${type}&transaction_status=${status}#transactions`;
        if (dateRange) url += `&date_range=${encodeURIComponent(dateRange)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        window.location.href = url;
    }

    function viewTransactionDetails(transactionId) {
        const row = document.getElementById(`transaction-${transactionId}`);
        if (!row) {
            showToast('Transaction not found', 'error');
            return;
        }
        
        const cells = row.cells;
        const transactionData = {
            id: transactionId,
            transactionId: cells[0].textContent,
            userId: cells[1].querySelector('small').textContent.replace('ID: ', ''),
            username: cells[1].querySelector('strong').textContent,
            type: cells[2].textContent.trim(),
            amount: cells[3].textContent,
            description: cells[4].querySelector('span')?.getAttribute('data-tooltip') || cells[4].textContent,
            date: cells[5].textContent,
            status: cells[6].textContent.trim()
        };
        
        document.getElementById('transactionDetailsContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">Transaction ID:</td>
                            <td class="fw-bold">${transactionData.transactionId}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">User:</td>
                            <td class="fw-bold">${transactionData.username}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">User ID:</td>
                            <td>${transactionData.userId}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Type:</td>
                            <td><span class="status-badge ${transactionData.type === 'DEPOSIT' ? 'verified' : transactionData.type === 'WITHDRAWAL' ? 'processing' : 'info'}">${transactionData.type}</span></td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">Amount:</td>
                            <td class="${transactionData.amount.includes('-') ? 'amount-negative' : 'amount-positive'}">${transactionData.amount}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Description:</td>
                            <td>${transactionData.description}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Date:</td>
                            <td>${transactionData.date}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td><span class="status-badge ${transactionData.status === 'COMPLETED' ? 'verified' : transactionData.status === 'PENDING' ? 'pending' : 'rejected'}">${transactionData.status}</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        transactionDetailsModal.show();
    }

    // ========== LOGS ACTIONS ==========
    function filterLogs() {
        const type = document.getElementById('logTypeFilter').value;
        const user = document.getElementById('logUserFilter').value;
        const dateRange = document.getElementById('logDateRange').value;
        const search = document.getElementById('logSearch').value;
        
        let url = `?log_type=${type}&log_user=${user}#logs`;
        if (dateRange) url += `&date_range=${encodeURIComponent(dateRange)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        window.location.href = url;
    }

    function clearLogs() {
        document.getElementById('confirmModalTitle').textContent = 'Clear Old Logs';
        document.getElementById('confirmModalMessage').textContent = 'Remove logs older than 30 days?';
        document.getElementById('confirmModalBtn').className = 'btn btn-danger';
        document.getElementById('confirmModalBtn').textContent = 'Clear';
        
        currentAction = 'clearLogs';
        confirmModal.show();
    }

    // ========== SETTINGS ACTIONS ==========
    async function saveSettings() {
        const settings = {
            config_min_deposit: document.getElementById('config_min_deposit')?.value || '800',
            config_mpesa_paybill: document.getElementById('config_mpesa_paybill')?.value || '123456',
            config_mpesa_account: document.getElementById('config_mpesa_account')?.value || 'INVEST',
            config_min_withdrawal: document.getElementById('config_min_withdrawal')?.value || '200',
            config_withdrawal_tax: document.getElementById('config_withdrawal_tax')?.value || '5',
            config_referral_commission: document.getElementById('config_referral_commission')?.value || '5',
            config_site_name: document.getElementById('config_site_name')?.value || 'XMR Investments',
            config_support_email: document.getElementById('config_support_email')?.value || 'support@example.com',
            config_support_phone: document.getElementById('config_support_phone')?.value || '0712345678',
            config_return_days: document.getElementById('config_return_days')?.value || '12',
            config_auto_payout: document.getElementById('config_auto_payout')?.value || '1',
            config_processing_time: document.getElementById('config_processing_time')?.value || '24',
            config_referral_bonus: document.getElementById('config_referral_bonus')?.value || '100',
            config_currency: document.getElementById('config_currency')?.value || 'KSH'
        };
        
        const result = await apiCall('update_settings', settings);
    }

    function resetSettings() {
        document.getElementById('confirmModalTitle').textContent = 'Reset Settings';
        document.getElementById('confirmModalMessage').textContent = 'Reset all settings to default values?';
        document.getElementById('confirmModalBtn').className = 'btn btn-warning';
        document.getElementById('confirmModalBtn').textContent = 'Reset';
        
        currentAction = 'resetSettings';
        confirmModal.show();
    }

    // ========== SYSTEM HEALTH ==========
    async function refreshSystemHealth() {
        try {
            const response = await fetch(SYSTEM_STATUS_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                },
                credentials: 'same-origin'
            });
            const result = await response.json();
            
            if (result.success) {
                updateHealthIndicator(result.status);
                updateHealthDropdown(result.status);
            }
        } catch (error) {
            console.error('Error checking system health:', error);
        }
    }

    function updateHealthIndicator(status) {
        const indicator = document.querySelector('.health-indicator');
        if (indicator) {
            if (status?.database?.users_total > 0) {
                indicator.style.background = '#10b981';
            } else {
                indicator.style.background = '#ef4444';
            }
        }
    }

    function updateHealthDropdown(status) {
        const healthContent = document.getElementById('healthContent');
        if (!healthContent || !status) return;
        
        const issues = [];
        if (status.wallets?.wallets_with_negative > 0) issues.push(`${status.wallets.wallets_with_negative} negative balances`);
        if (status.investments?.overdue > 0) issues.push(`${status.investments.overdue} overdue payouts`);
        
        healthContent.innerHTML = `
            <div class="health-grid">
                <div class="health-item">
                    <div class="health-status ${status.database?.users_total > 0 ? 'healthy' : 'warning'}"></div>
                    <div>
                        <small>Database</small>
                        <div>${status.database?.users_total || 0} users</div>
                    </div>
                </div>
                <div class="health-item">
                    <div class="health-status ${status.wallets?.wallets_with_negative === 0 ? 'healthy' : 'critical'}"></div>
                    <div>
                        <small>Wallets</small>
                        <div>${status.wallets?.total_wallets || 0} total</div>
                    </div>
                </div>
                <div class="health-item">
                    <div class="health-status ${status.investments?.overdue === 0 ? 'healthy' : 'warning'}"></div>
                    <div>
                        <small>Investments</small>
                        <div>${status.investments?.active || 0} active</div>
                    </div>
                </div>
                <div class="health-item">
                    <div class="health-status ${status.transactions?.pending === 0 ? 'healthy' : 'warning'}"></div>
                    <div>
                        <small>Transactions</small>
                        <div>${status.transactions?.pending || 0} pending</div>
                    </div>
                </div>
            </div>
            ${issues.length > 0 ? `
                <div class="mt-3 p-2 bg-danger bg-opacity-10 rounded">
                    <small class="text-danger">â ï¸ Issues: ${issues.join(', ')}</small>
                </div>
            ` : ''}
        `;
    }

    function openSystemStatus() {
        systemStatusModal.show();
        refreshSystemStatus();
    }

    async function refreshSystemStatus() {
        showLoading('Checking system status...');
        try {
            const response = await fetch(SYSTEM_STATUS_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                },
                credentials: 'same-origin'
            });
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                displaySystemStatus(result.status);
            } else {
                showToast('Error getting system status', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast('Error: ' + error.message, 'error');
        }
    }

    function displaySystemStatus(status) {
        const content = document.getElementById('systemStatusContent');
        if (!content) return;
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Database</h6>
                    <table class="table table-sm">
                        <tr><td>Total Users:</td><td class="fw-bold">${status.database?.users_total || 0}</td></tr>
                        <tr><td>Active (24h):</td><td>${status.database?.users_active_last_day || 0}</td></tr>
                        <tr><td>New Today:</td><td>${status.database?.users_active_last_hour || 0}</td></tr>
                    </table>
                    
                    <h6 class="mt-3">Wallets</h6>
                    <table class="table table-sm">
                        <tr><td>Total Wallets:</td><td>${status.wallets?.total_wallets || 0}</td></tr>
                        <tr><td>Available Balance:</td><td class="amount-positive">${status.wallets?.total_available_balance?.toLocaleString() || 0} KSH</td></tr>
                        <tr><td>Locked Balance:</td><td class="amount-payout">${status.wallets?.total_locked_balance?.toLocaleString() || 0} KSH</td></tr>
                        <tr><td>Negative Balances:</td><td class="${status.wallets?.wallets_with_negative > 0 ? 'text-danger' : 'text-success'}">${status.wallets?.wallets_with_negative || 0}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Investments</h6>
                    <table class="table table-sm">
                        <tr><td>Active:</td><td class="text-success">${status.investments?.active || 0}</td></tr>
                        <tr><td>Completed:</td><td>${status.investments?.completed || 0}</td></tr>
                        <tr><td>Total Invested:</td><td class="amount">${status.investments?.total_invested?.toLocaleString() || 0} KSH</td></tr>
                        <tr><td>Due Today:</td><td class="text-warning">${status.investments?.due_for_payout || 0}</td></tr>
                        <tr><td>Overdue:</td><td class="text-danger">${status.investments?.overdue || 0}</td></tr>
                    </table>
                    
                    <h6 class="mt-3">Pending Actions</h6>
                    <table class="table table-sm">
                        <tr><td>Deposits:</td><td class="text-warning">${status.deposits?.pending || 0}</td></tr>
                        <tr><td>Withdrawals:</td><td class="text-info">${status.withdrawals?.pending || 0}</td></tr>
                        <tr><td>KYC:</td><td class="text-primary">${status.kyc?.pending || 0}</td></tr>
                        <tr><td>Transactions:</td><td>${status.transactions?.pending || 0}</td></tr>
                    </table>
                </div>
            </div>
        `;
    }

    // ========== MAINTENANCE ACTIONS ==========
    function openMaintenanceMenu() {
        maintenanceModal.show();
    }

    async function runMaintenance(action) {
        maintenanceModal.hide();
        
        const actions = {
            'fix_wallets': {
                title: 'Fix All Wallets',
                message: 'This will recalculate and fix all wallet balances. Continue?',
                url: FIX_WALLETS_URL,
                method: 'POST'
            },
            'check_expired': {
                title: 'Check Expired Investments',
                message: 'Mark all expired investments as completed?',
                url: '{% url "XMR:admin_check_expired" %}',
                method: 'POST'
            },
            'run_payouts': {
                title: 'Run Daily Payouts',
                message: 'Process all due payouts?',
                url: '{% url "XMR:admin_trigger_payout" %}',
                method: 'POST'
            },
            'catch_up_payouts': {
                title: 'Catch Up All Payouts',
                message: 'Process ALL missed payouts for ALL users?',
                url: CATCH_UP_URL,
                method: 'POST'
            },
            'clear_logs': {
                title: 'Clear Old Logs',
                message: 'Remove logs older than 30 days?',
                action: 'clear_logs'
            }
        };
        
        const config = actions[action];
        if (!config) return;
        
        document.getElementById('confirmModalTitle').textContent = config.title;
        document.getElementById('confirmModalMessage').textContent = config.message;
        document.getElementById('confirmModalBtn').className = 'btn btn-warning';
        document.getElementById('confirmModalBtn').textContent = 'Execute';
        
        currentAction = action;
        confirmModal.show();
    }

    // ========== EXPORT ACTIONS ==========
    function exportData(type) {
        const urls = {
            'users': EXPORT_USERS_URL,
            'transactions': EXPORT_TRANSACTIONS_URL,
            'deposits': '{% url "XMR:export_deposits_csv" %}',
            'withdrawals': '{% url "XMR:export_withdrawals_csv" %}',
            'investments': '{% url "XMR:export_investments_csv" %}',
            'tokens': '{% url "XMR:export_tokens_csv" %}',
            'kyc': '{% url "XMR:export_kyc_csv" %}',
            'logs': '{% url "XMR:export_logs_csv" %}'
        };
        
        const url = urls[type];
        if (url) {
            window.location.href = url;
            showToast(`Exporting ${type}...`, 'info');
        }
    }

    // ========== UTILITY FUNCTIONS ==========
    function viewScreenshot(imageUrl) {
        if (imageUrl && imageUrl !== 'None' && imageUrl !== '') {
            viewImage(imageUrl);
        } else {
            showToast('No screenshot available', 'info');
        }
    }

    function viewImage(imageUrl) {
        document.getElementById('previewImage').src = imageUrl;
        document.getElementById('downloadImageBtn').href = imageUrl;
        imagePreviewModal.show();
    }

    // ========== CONFIRMATION HANDLER ==========
    document.getElementById('confirmModalBtn')?.addEventListener('click', async function() {
        confirmModal.hide();
        
        if (currentAction === 'verifyDeposit') {
            const result = await apiCall('verify_deposit', { deposit_id: currentItemId });
            if (result.success) {
                document.getElementById(`deposit-${currentItemId}`)?.remove();
                updateNotificationCounts();
            }
        } else if (currentAction === 'rejectDeposit') {
            const result = await apiCall('reject_deposit', {
                deposit_id: currentItemId,
                reason: currentItemData?.reason || ''
            });
            if (result.success) {
                document.getElementById(`deposit-${currentItemId}`)?.remove();
                updateNotificationCounts();
            }
        } else if (currentAction === 'processWithdrawal') {
            const result = await apiCall('process_withdrawal', {
                withdrawal_id: currentItemId
            });
            if (result.success) {
                const row = document.getElementById(`withdrawal-${currentItemId}`);
                if (row) {
                    const statusCell = row.querySelector('.status-badge');
                    if (statusCell) {
                        statusCell.className = 'status-badge processing';
                        statusCell.textContent = 'PROCESSING';
                    }
                }
            }
        } else if (currentAction === 'completeWithdrawal') {
            const result = await apiCall('complete_withdrawal', {
                withdrawal_id: currentItemId,
                transaction_code: currentItemData?.code || ''
            });
            if (result.success) {
                const row = document.getElementById(`withdrawal-${currentItemId}`);
                if (row) {
                    row.remove();
                    updateNotificationCounts();
                }
            }
        } else if (currentAction === 'rejectWithdrawal') {
            const result = await apiCall('reject_withdrawal', {
                withdrawal_id: currentItemId,
                reason: currentItemData?.reason || ''
            });
            if (result.success) {
                const row = document.getElementById(`withdrawal-${currentItemId}`);
                if (row) {
                    row.remove();
                    updateNotificationCounts();
                }
            }
        } else if (currentAction === 'processPayout') {
            const result = await apiCall('process_payout', {
                investment_id: currentItemId
            });
            if (result.success) {
                showToast('Payout processed successfully', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        } else if (currentAction === 'forceCompleteInvestment') {
            const result = await apiCall('force_complete_investment', {
                investment_id: currentItemId
            });
            if (result.success) {
                showToast('Investment force completed', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        } else if (currentAction === 'toggleUserBan') {
            const result = await apiCall('toggle_user_ban', {
                user_id: currentItemId,
                reason: currentItemData?.reason || ''
            });
            if (result.success) {
                const row = document.getElementById(`user-${currentItemId}`);
                if (row) {
                    const statusCell = row.querySelectorAll('td')[8];
                    const banBtn = row.querySelector('.btn-icon.danger, .btn-icon.success');
                    
                    if (currentItemData?.ban) {
                        statusCell.innerHTML = '<span class="status-badge rejected">Banned</span>';
                        if (banBtn) {
                            banBtn.className = 'btn-icon success';
                            banBtn.innerHTML = '<i class="bi bi-unlock"></i>';
                            banBtn.setAttribute('onclick', `toggleUserBan(${currentItemId}, false)`);
                            banBtn.setAttribute('data-tooltip', 'Unban');
                        }
                    } else {
                        statusCell.innerHTML = '<span class="status-badge verified">Active</span>';
                        if (banBtn) {
                            banBtn.className = 'btn-icon danger';
                            banBtn.innerHTML = '<i class="bi bi-lock"></i>';
                            banBtn.setAttribute('onclick', `toggleUserBan(${currentItemId}, true)`);
                            banBtn.setAttribute('data-tooltip', 'Ban');
                        }
                    }
                }
            }
        } else if (currentAction === 'toggleTokenStatus') {
            const result = await apiCall('update_token', {
                token_id: currentItemId,
                status: currentItemData?.status
            });
            if (result.success) {
                setTimeout(() => location.reload(), 1500);
            }
        } else if (currentAction === 'verifyKyc') {
            if (currentItemData?.phone && currentItemData?.id) {
                await apiCall('verify_kyc_all', { profile_id: currentItemId });
            } else if (currentItemData?.phone) {
                await apiCall('verify_kyc_phone', { profile_id: currentItemId });
            } else if (currentItemData?.id) {
                await apiCall('verify_kyc_id', { profile_id: currentItemId });
            }
            document.getElementById(`kyc-${currentItemId}`)?.remove();
            updateNotificationCounts();
        } else if (currentAction === 'rejectKyc') {
            showToast('KYC rejected: ' + (currentItemData?.reason || ''), 'warning');
            document.getElementById(`kyc-${currentItemId}`)?.remove();
            updateNotificationCounts();
        } else if (currentAction === 'catchUpAllPayouts') {
            showLoading('Processing all payouts...');
            try {
                const response = await fetch(CATCH_UP_URL, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                    },
                    credentials: 'same-origin'
                });
                const result = await response.json();
                hideLoading();
                if (result.success) {
                    showToast(`â Processed ${result.processed} payouts for ${result.users} users`, 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast(result.error || 'Error processing payouts', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Network error: ' + error.message, 'error');
            }
        } else if (currentAction === 'runDailyPayouts') {
            showLoading('Running daily payouts...');
            try {
                const response = await fetch('{% url "XMR:admin_trigger_payout" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                    },
                    credentials: 'same-origin'
                });
                const result = await response.json();
                hideLoading();
                if (result.success) {
                    showToast(`Processed ${result.processed} payouts`, 'success');
                    refreshPayoutStats();
                } else {
                    showToast(result.error || 'Error', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        } else if (currentAction === 'checkExpiredInvestments') {
            showLoading('Checking expired investments...');
            try {
                const response = await fetch('{% url "XMR:admin_check_expired" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                    },
                    credentials: 'same-origin'
                });
                const result = await response.json();
                hideLoading();
                if (result.success) {
                    showToast(`Marked ${result.count} investments as completed`, 'success');
                } else {
                    showToast(result.error || 'Error', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        } else if (currentAction === 'fix_wallets') {
            showLoading('Fixing wallets...');
            try {
                const response = await fetch(FIX_WALLETS_URL, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                    },
                    credentials: 'same-origin'
                });
                const result = await response.json();
                hideLoading();
                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast(result.error || 'Error', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        } else if (currentAction === 'clearLogs') {
            showToast('Logs cleared', 'success');
        } else if (currentAction === 'resetSettings') {
            document.getElementById('config_min_deposit').value = '800';
            document.getElementById('config_mpesa_paybill').value = '123456';
            document.getElementById('config_mpesa_account').value = 'INVEST';
            document.getElementById('config_min_withdrawal').value = '200';
            document.getElementById('config_withdrawal_tax').value = '5';
            document.getElementById('config_referral_commission').value = '5';
            document.getElementById('config_site_name').value = 'XMR Investments';
            document.getElementById('config_support_email').value = 'support@example.com';
            document.getElementById('config_support_phone').value = '0712345678';
            document.getElementById('config_return_days').value = '12';
            document.getElementById('config_auto_payout').value = '1';
            document.getElementById('config_processing_time').value = '24';
            document.getElementById('config_referral_bonus').value = '100';
            document.getElementById('config_currency').value = 'KSH';
            showToast('Settings reset to defaults', 'success');
        }
        
        currentAction = null;
        currentItemId = null;
        currentItemData = null;
    });

    // ========== KEYBOARD SHORTCUTS ==========
    document.addEventListener('keydown', function(e) {
        // Ctrl+1 through Ctrl+9 for tabs
        if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
            e.preventDefault();
            const tabs = ['dashboard', 'deposits', 'withdrawals', 'investments', 'payouts', 'users', 'tokens', 'kyc', 'transactions', 'logs'];
            const index = parseInt(e.key) - 1;
            if (tabs[index]) {
                switchTab(tabs[index]);
            }
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
        }
        
        // Ctrl+R to refresh current tab
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            if (currentTab === 'dashboard') {
                refreshDashboard();
            } else if (currentTab === 'payouts') {
                refreshPayoutStats();
            } else if (currentTab === 'logs') {
                filterLogs();
            } else {
                location.reload();
            }
        }
        
        // Ctrl+F to focus search
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const searchInput = document.querySelector('.search-box input');
            if (searchInput) {
                searchInput.focus();
            }
        }
    });

    // ========== AUTO-REFRESH ==========
    setInterval(function() {
        if (currentTab === 'deposits') {
            // Auto-refresh deposits data
        } else if (currentTab === 'withdrawals') {
            // Auto-refresh withdrawals data
        } else if (currentTab === 'payouts' || currentTab === 'dashboard') {
            refreshPayoutStats();
        }
    }, 30000);
</script>
</body>
</html>